/*!
 * Portions of this code are derived from MultiversX libraries.
 * These portions are licensed under the MIT License.
 *
 * See the MultiversX repository for details: https://github.com/multiversx
 */

var dt=r=>r.match(/.{1,2}/g)?.length===32,D=r=>new TextEncoder().encode(r),P=r=>{let t=[];for(let e=0;e<r.length;e+=2)t.push(parseInt(r.slice(e,e+2),16));return Uint8Array.from(t)},M=r=>new TextDecoder().decode(r),y=r=>Array.from(r).map(t=>t.toString(16).padStart(2,"0")).join(""),W=r=>{let t=D(r);return y(t)},S=r=>{let t;function e(n){try{return btoa(atob(n))===n}catch{return!1}}if(e(r)){let n=atob(r),s=n.length;t=new Uint8Array(s);for(let i=0;i<s;i++)t[i]=n.charCodeAt(i)}else t=new TextEncoder().encode(r);return t},L=r=>{if(!r||!r.length)return;let t;if(typeof r=="string")t=new TextEncoder().encode(r);else if(r instanceof Uint8Array)t=r;else return;let e=String.fromCharCode(...t);return btoa(e)};function nt(r){let t=new URLSearchParams(r),e={};for(let[n,s]of t.entries()){let i=n.match(/^(\w+)(?:\[(\d*)\])?$/);if(i){let o=i[1],c=i[2]!==void 0?Number(i[2]):null;c!==null?(e[o]||(e[o]=[]),e[o][c]=s):e[o]?Array.isArray(e[o])?e[o].push(s):e[o]=[e[o],s]:e[o]=s}}return e}function ut(r){let t=[];for(let e in r)if(Object.prototype.hasOwnProperty.call(r,e))if(Array.isArray(r[e]))r[e].forEach((n,s)=>{t.push(`${e}[${s}]=${encodeURIComponent(n)}`)});else if(typeof r[e]=="object")for(let n in r[e])t.push(`${e}[${n}]=${encodeURIComponent(r[e][n])}`);else t.push(`${e}=${encodeURIComponent(r[e])}`);return t.join("&")}var b=class{constructor(t){this.address=new Uint8Array([]);this.nonce=0;this.balance="0";dt(t)&&(this.address=P(t))}update(t){this.nonce=t.nonce,this.balance=t.balance}incrementNonce(){this.nonce=this.nonce+1}getNonceThenIncrement(){let t=this.nonce;return this.nonce=this.nonce+1,t}toJSON(){return{address:y(this.address),nonce:this.nonce,balance:this.balance}}bech32(){return y(this.address)}};var gt="sdk-js";var pt="hook/login",ht="hook/logout";var mt="hook/sign",ft="hook/2fa",wt="hook/sign-message",N="walletProviderStatus",$="transactionsSigned";var R=class{constructor(t){this.nonce=BigInt(t.nonce?.valueOf()||0n),this.value=t.value??0n,this.sender=this.addressAsBech32(t.sender),this.receiver=this.addressAsBech32(t.receiver),this.senderUsername=t.senderUsername||"",this.receiverUsername=t.receiverUsername||"",this.gasPrice=BigInt(t.gasPrice?.valueOf()||1e9),this.gasLimit=BigInt(t.gasLimit.valueOf()),this.data=t.data?.valueOf()||new Uint8Array,this.chainID=t.chainID.valueOf(),this.version=Number(t.version?.valueOf()||2),this.options=Number(t.options?.valueOf()||0),this.guardian=t.guardian?this.addressAsBech32(t.guardian):"",this.signature=t.signature||new Uint8Array([]),this.guardianSignature=t.guardianSignature||new Uint8Array([]),this.relayer=t.relayer||"",this.innerTransactions=t.innerTransactions||[]}addressAsBech32(t){return t}isGuardedTransaction(){let t=this.guardian.length>0,e=this.guardianSignature.length>0;return t&&e}};var w=class extends Error{constructor(e,n){super(e);this.inner=void 0;this.inner=n}summary(){let e=[];e.push({name:this.name,message:this.message});let n=this.inner;for(;n;)e.push({name:n.name,message:n.message}),n=n.inner;return e}};var G=class extends w{constructor(){super("Async timer already running")}},H=class extends w{constructor(){super("Async timer aborted")}};var U=class extends w{constructor(){super("Expected transaction status not reached")}},C=class extends w{constructor(){super("Expected transaction events not found")}};var B=class extends w{constructor(){super("The transaction watcher requires the `isCompleted` property to be defined on the transaction object. Perhaps you've used the sdk-network-provider's `ProxyNetworkProvider.getTransaction()` and in that case you should also pass `withProcessStatus=true`.")}};var Q=class extends w{constructor(){super("Cannot sign single transaction.")}},z=class extends w{constructor(){super("Account is not connected.")}},O=class extends Error{constructor(){super("Cannot get signed transaction(s)")}},V=class extends Error{constructor(){super("Cannot get signed message")}};var E=class{constructor(t){this.timeoutHandle=null;this.rejectionFunc=null;this.name=t,this.correlationTag=0}start(t){if(this.timeoutHandle)throw new G;return this.correlationTag++,new Promise((e,n)=>{this.rejectionFunc=n;let s=()=>{this.rejectionFunc=null,this.stop(),e()};this.timeoutHandle=setTimeout(s,t)})}abort(){this.rejectionFunc&&(this.rejectionFunc(new H),this.rejectionFunc=null),this.stop()}stop(){this.isStopped()||this.timeoutHandle&&(clearTimeout(this.timeoutHandle),this.timeoutHandle=null)}isStopped(){return!this.timeoutHandle}};var it=class{constructor(t){this.fetcher=t}async getTransaction(t){return await this.fetcher.getTransaction(t)}},_=class r{static{this.DefaultPollingInterval=6e3}static{this.DefaultTimeout=r.DefaultPollingInterval*15}static{this.DefaultPatience=0}static{this.NoopOnStatusReceived=()=>{}}constructor(t,e={}){this.fetcher=new it(t),this.pollingIntervalMilliseconds=e.pollingIntervalMilliseconds||r.DefaultPollingInterval,this.timeoutMilliseconds=e.timeoutMilliseconds||r.DefaultTimeout,this.patienceMilliseconds=e.patienceMilliseconds||r.DefaultPatience}async awaitPending(t){let e=i=>i.status.isPending(),n=async()=>{let i=this.transactionOrTxHashToTxHash(t);return await this.fetcher.getTransaction(i)},s=()=>new U;return this.awaitConditionally(e,n,s)}async awaitCompleted(t){let e=i=>{if(i.isCompleted===void 0)throw new B;return i.isCompleted},n=async()=>{let i=this.transactionOrTxHashToTxHash(t);return await this.fetcher.getTransaction(i)},s=()=>new U;return this.awaitConditionally(e,n,s)}async awaitAllEvents(t,e){let n=o=>{let c=this.getAllTransactionEvents(o).map(u=>u.identifier);return e.every(u=>c.includes(u))},s=async()=>{let o=this.transactionOrTxHashToTxHash(t);return await this.fetcher.getTransaction(o)},i=()=>new C;return this.awaitConditionally(n,s,i)}async awaitAnyEvent(t,e){let n=o=>{let c=this.getAllTransactionEvents(o).map(u=>u.identifier);return e.find(u=>c.includes(u))!=null},s=async()=>{let o=this.transactionOrTxHashToTxHash(t);return await this.fetcher.getTransaction(o)},i=()=>new C;return this.awaitConditionally(n,s,i)}async awaitOnCondition(t,e){let n=async()=>{let i=this.transactionOrTxHashToTxHash(t);return await this.fetcher.getTransaction(i)},s=()=>new U;return this.awaitConditionally(e,n,s)}transactionOrTxHashToTxHash(t){let e=typeof t=="string"?t:t.getHash().hex();if(e.length!==64)throw new w(`Invalid transaction hash length. The length of a hex encoded hash should be ${64}.`);return e}async awaitConditionally(t,e,n){let s=new E("watcher:periodic"),i=new E("watcher:patience"),o=new E("watcher:timeout"),c=!1,d,u=!1;for(o.start(this.timeoutMilliseconds).finally(()=>{o.stop(),c=!0});!c&&(await s.start(this.pollingIntervalMilliseconds),d=await e(),u=t(d),!(u||c)););if(u&&await i.start(this.patienceMilliseconds),o.isStopped()||o.stop(),!d||!u)throw n();return d}getAllTransactionEvents(t){let e=[...t.logs.events];for(let n of t.contractResults.items)e.push(...n.logs.events);return e}};var v=class{constructor(t){this.data=t.data,this.signature=t.signature,this.address=t.address,this.version=t.version||1,this.signer=t.signer||gt}};var T=class{static transactionToPlainObject(t){return{nonce:Number(t.nonce),value:t.value.toString(),receiver:t.receiver,sender:t.sender,senderUsername:L(t.senderUsername),receiverUsername:L(t.receiverUsername),gasPrice:Number(t.gasPrice),gasLimit:Number(t.gasLimit),data:L(t.data),chainID:t.chainID,version:t.version,options:t.options==0?void 0:t.options,guardian:t.guardian?t.guardian:void 0,signature:y(t.signature),guardianSignature:y(t.guardianSignature),relayer:t.relayer?t.relayer:void 0,innerTransactions:t.innerTransactions.length?t.innerTransactions.map(e=>this.transactionToPlainObject(e)):void 0}}static plainObjectToTransaction(t){return new R({nonce:BigInt(t.nonce),value:BigInt(t.value||""),receiver:t.receiver,receiverUsername:S(t.receiverUsername||"").toString(),sender:t.sender,senderUsername:S(t.senderUsername||"").toString(),guardian:t.guardian,gasPrice:BigInt(t.gasPrice),gasLimit:BigInt(t.gasLimit),data:S(t.data||""),chainID:String(t.chainID),version:Number(t.version),options:Number(t.options),signature:P(t.signature||""),guardianSignature:P(t.guardianSignature||""),relayer:t.relayer,innerTransactions:t.innerTransactions?t.innerTransactions.map(n=>this.plainObjectToTransaction(n)):void 0})}};var I=class r{constructor(){this.account={address:""};this.initialized=!1;if(r._instance)throw new Error("Error: Instantiation failed: Use ExtensionProvider.getInstance() instead of new.");r._instance=this}static{this._instance=new r}static getInstance(){return r._instance}setAddress(t){return this.account.address=t,r._instance}async init(){return window&&window.elrondWallet&&(this.initialized=!0),this.initialized}async login(t={}){if(!this.initialized)throw new Error("Extension provider is not initialised, call init() first");let{token:e}=t,n=e||"";return await this.startBgrMsgChannel("connect",n),this.account}async logout(){if(!this.initialized)throw new Error("Extension provider is not initialised, call init() first");try{await this.startBgrMsgChannel("logout",this.account.address),this.disconnect()}catch(t){console.warn("Extension origin url is already cleared!",t)}return!0}disconnect(){this.account={address:""}}async getAddress(){if(!this.initialized)throw new Error("Extension provider is not initialised, call init() first");return this.account?this.account.address:""}isInitialized(){return this.initialized}isConnected(){return!!this.account.address}getAccount(){return this.account}setAccount(t){this.account=t}async signTransaction(t){this.ensureConnected();let e=await this.signTransactions([t]);if(e.length!=1)throw new Q;return e[0]}ensureConnected(){if(!this.account.address)throw new z}async signTransactions(t){this.ensureConnected();let e=await this.startBgrMsgChannel("signTransactions",{from:this.account.address,transactions:t.map(n=>T.transactionToPlainObject(n))});try{return e.map(s=>T.plainObjectToTransaction(s))}catch(n){throw new Error(`Transaction canceled: ${n.message}.`)}}async signMessage(t){this.ensureConnected();let e={account:this.account.address,message:M(t.data)},s=(await this.startBgrMsgChannel("signMessage",e)).signature,i=P(s);return new v({data:t.data,address:t.address??this.account.address,signer:"extension",version:t.version,signature:i})}cancelAction(){return this.startBgrMsgChannel("cancelAction",{})}startBgrMsgChannel(t,e){return new Promise(n=>{window.postMessage({target:"erdw-inpage",type:t,data:e},window.origin);let s=i=>{i.isTrusted&&i.data.target==="erdw-contentScript"&&(i.data.type==="connectResponse"?(i.data.data&&i.data.data.address&&(this.account=i.data.data),window.removeEventListener("message",s),n(i.data.data)):(window.removeEventListener("message",s),n(i.data.data)))};window.addEventListener("message",s,!1)})}};var j="elvenjs_state",Tt="https://devnet-api.multiversx.com";var A="/dapp/init",q="devnet";var xt=["wss://relay.walletconnect.com"],x={devnet:{id:"devnet",shortId:"D",name:"Devnet",egldLabel:"xEGLD",egldDenomination:"18",decimals:"4",gasPerDataByte:"1500",walletAddress:"https://devnet-wallet.multiversx.com",xAliasAddress:"https://devnet.xalias.com",apiAddress:"https://devnet-api.multiversx.com",explorerAddress:"https://devnet-explorer.multiversx.com",apiTimeout:1e4},testnet:{id:"testnet",shortId:"T",name:"Testnet",egldLabel:"xEGLD",egldDenomination:"18",decimals:"4",gasPerDataByte:"1500",walletAddress:"https://testnet-wallet.multiversx.com",xAliasAddress:"https://testnet.xalias.com",apiAddress:"https://testnet-api.multiversx.com",explorerAddress:"https://testnet-explorer.multiversx.com",apiTimeout:1e4},mainnet:{id:"mainnet",shortId:"1",name:"Mainnet",egldLabel:"EGLD",egldDenomination:"18",decimals:"4",gasPerDataByte:"1500",walletAddress:"https://wallet.multiversx.com",xAliasAddress:"https://xalias.com",apiAddress:"https://api.multiversx.com",explorerAddress:"https://explorer.multiversx.com",apiTimeout:1e4}};var l={get(r){let t=localStorage.getItem(j);if(!t)return{};let e=JSON.parse(t);return r?e[r]:e},set(r,t){let e=this.get();e[r]=t,localStorage.setItem(j,JSON.stringify(e))},clear(){localStorage.removeItem(j)}};var K=async()=>{let r=I.getInstance();try{let t=await r.init(),e=l.get();if(e?.address&&r.setAddress(e.address),!t){console.warn("Something went wrong when trying to initialize the ExtensionProvider..");return}return r}catch{console.warn("Can't initialize the Dapp Provider!")}};var st=class{constructor(t){this.nonce=0;this.value="";this.receiver="";this.sender="";this.gasPrice=0;this.gasLimit=0;this.data="";this.chainID="";this.version=0;this.signature="";Object.assign(this,t)}},m=class r{constructor(t){this.walletUrl=t}async login(t){let e=this.buildWalletUrl({endpoint:pt,callbackUrl:t?.callbackUrl,params:{token:t?.token}});return await this.redirect(e,t?.redirectDelayMilliseconds),e}async redirect(t,e){e?await this.redirectLater(t,e):this.redirectImmediately(t)}redirectImmediately(t){window.location.href=t}async redirectLater(t,e){await new Promise(n=>{setTimeout(()=>{window.location.href=t,n(!0)},e)})}async logout(t){let e=this.buildWalletUrl({endpoint:ht,callbackUrl:t?.callbackUrl});return await this.redirect(e,t?.redirectDelayMilliseconds),!0}async signMessage(t,e){let n=new v({data:t.data,address:t.address,signer:"web-wallet",version:t.version}),s=this.buildWalletUrl({endpoint:wt,callbackUrl:e?.callbackUrl,params:{message:n.data.toString()}});return await this.redirect(s),s}getMessageSignatureFromWalletUrl(){let t=window.location.search.slice(1);console.info("getMessageSignatureFromWalletUrl(), url:",t);let e=nt(t);if((e.status?.toString()||"")!=="signed")throw new V;return e.signature?.toString()||""}async guardTransactions(t,e){this.redirectTransactionsToEndpoint(ft,t,e)}async signTransactions(t,e){this.redirectTransactionsToEndpoint(mt,t,e)}async signTransaction(t,e){await this.signTransactions([t],e)}getTransactionsFromWalletUrl(t=window.location.search){let e=nt(t.slice(1));return r.isTxSignReturnSuccess(e)?this.getTxSignReturnValue(e):[]}static isTxSignReturnSuccess(t){return Object.prototype.hasOwnProperty.call(t,N)&&t[N]===$}getTxSignReturnValue(t){console.info("getTxSignReturnValue(), urlParams:",t);let e=["nonce","value","receiver","sender","gasPrice","gasLimit","chainID","version","signature"];for(let i of e)if(!t[i]||!Array.isArray(t[i]))throw new O;let n=t.nonce.length;for(let i of e)if(t[i].length!==n)throw new O;let s=[];for(let i=0;i<n;i++){let o=new st({nonce:parseInt(t.nonce[i]),value:t.value[i],receiver:t.receiver[i],sender:t.sender[i],gasPrice:parseInt(t.gasPrice[i]),gasLimit:parseInt(t.gasLimit[i]),data:t.data&&t.data[i]?t.data[i]:"",chainID:t.chainID[i],version:parseInt(t.version[i]),...t.guardian&&t.guardian[i]?{guardian:t.guardian[i]}:{},...t.guardianSignature&&t.guardianSignature[i]?{guardianSignature:t.guardianSignature[i]}:{},...t.options&&t.options[i]?{options:parseInt(t.options[i])}:{},...t.senderUsername&&t.senderUsername[i]?{senderUsername:t.senderUsername[i]}:{},...t.receiverUsername&&t.receiverUsername[i]?{receiverUsername:t.receiverUsername[i]}:{},signature:t.signature[i]});s.push(o)}return s}static prepareWalletTransaction(t){let e=T.transactionToPlainObject(t);return e.data?e.data=M(S(e.data)):e.data="",e}buildWalletUrl(t){let e=t?.callbackUrl||window.location.href,n=ut(t.params||{}),s=n?`${n}&callbackUrl=${e}`:`callbackUrl=${e}`,i=`${this.baseWalletUrl()}/${t.endpoint}?${s}`;return console.info(`Redirecting to Wallet URL: ${decodeURI(i)}`),i}baseWalletUrl(){let t=this.walletUrl.split("/"),e=t[0],n=t[2];return e+"//"+n}redirectTransactionsToEndpoint(t,e,n){let s={};e.map(o=>{let c=r.prepareWalletTransaction(o);for(let d in c)Object.prototype.hasOwnProperty.call(c,d)&&!Object.prototype.hasOwnProperty.call(s,d)&&(s[d]=[]),s[d].push(c[d])});let i=this.buildWalletUrl({endpoint:t,callbackUrl:n?.callbackUrl,params:s});window.location.href=i}};var ot=class{constructor(){this.origin=typeof window<"u"&&typeof window.location<"u"?window.location.hostname:"";this.apiUrl="https://api.multiversx.com";this.expirySeconds=60*60*24}},k=class{constructor(t){this.config=Object.assign(new ot,t)}getToken(t,e,n){let s=this.encodeValue(t),i=this.encodeValue(e);return`${s}.${i}.${n}`}async initialize(t={}){let e=await this.getCurrentBlockHash(),n=this.encodeValue(JSON.stringify(t));return`${this.encodeValue(this.config.origin)}.${e}.${this.config.expirySeconds}.${n}`}async getCurrentBlockHash(){return this.config.gatewayUrl?await this.getCurrentBlockHashWithGateway():await this.getCurrentBlockHashWithApi()}async getCurrentBlockHashWithGateway(){let t=await this.getCurrentRound(),e=`${this.config.gatewayUrl}/blocks/by-round/${t}`;return(await this.get(e)).data.data.blocks.filter(o=>o.shard===this.config.blockHashShard)[0].hash}async getCurrentRound(){if(!this.config.gatewayUrl)throw new Error("Gateway URL not set");if(!this.config.blockHashShard)throw new Error("Blockhash shard not set");let t=`${this.config.gatewayUrl}/network/status/${this.config.blockHashShard}`;return(await this.get(t)).data.data.status.erd_current_round}async getCurrentBlockHashWithApi(){let t=`${this.config.apiUrl}/blocks/latest?ttl=${this.config.expirySeconds}&fields=hash`,e=await this.get(t);return e.hash!==void 0?e.hash:this.getCurrentBlockHashWithApiFallback()}async getCurrentBlockHashWithApiFallback(){let t=`${this.config.apiUrl}/blocks?size=1&fields=hash`;return this.config.blockHashShard!==void 0&&(t+=`&shard=${this.config.blockHashShard}`),(await this.get(t)).hash}encodeValue(t){return this.escape(W(t))}escape(t){return t.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}async get(t){try{let e=await fetch(t,{method:"GET",headers:this.config.extraRequestHeaders});if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return await e.json()}catch(e){throw console.error("There was a problem with the fetch operation:",e),e}}};var h=r=>{if(typeof window<"u"){let t=new URL(window.location.href);return new URLSearchParams(t.search).get(r)}};var yt=async(r,t)=>{let e=h("signature"),n=h("address"),s=l.get("address"),i=l.get("loginToken");if(e&&l.set("signature",e),n||s){n&&(l.set("address",n),window.history.replaceState(null,"",window.location.pathname));let o=new m(`${r}${A}`);if(e&&t&&n){let d=new k({apiUrl:t,origin:window.location.origin}).getToken(n,i,e);l.set("accessToken",d)}return o}};var J=class r{constructor(t){this.status=(t||"").toLowerCase()}static createUnknown(){return new r("unknown")}isPending(){return this.status=="received"||this.status=="pending"}isExecuted(){return this.isSuccessful()||this.isFailed()||this.isInvalid()}isSuccessful(){return this.status=="executed"||this.status=="success"||this.status=="successful"}isFailed(){return this.status=="fail"||this.status=="failed"||this.status=="unsuccessful"||this.isInvalid()}isInvalid(){return this.status=="invalid"}toString(){return this.status}valueOf(){return this.status}equals(t){return t?this.status==t.status:!1}};var X=class{constructor({apiUrl:t,chainType:e,apiTimeout:n}){this.chainType=e||q,this.apiUrl=t||x[this.chainType]?.apiAddress,this.apiTimeout=n||x[this.chainType]?.apiTimeout}async apiGet(t,e){if(typeof fetch<"u"){let n=new AbortController,s=setTimeout(()=>n.abort(),this.apiTimeout),i={method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"},signal:n.signal};try{let o=await fetch(this.apiUrl+"/"+t,Object.assign(i,e||{})),c=await o.json();if(!o.ok){let d=c?.error||o.status;return clearTimeout(s),Promise.reject(d)}return clearTimeout(s),c}catch(o){this.handleApiError(o,t)}}}async apiPost(t,e,n){if(typeof fetch<"u"){let s=new AbortController,i=setTimeout(()=>s.abort(),this.apiTimeout),o={method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(e||{}),signal:s.signal};try{let c=await fetch(this.apiUrl+"/"+t,Object.assign(o,n||{})),d=await c.json();if(!c.ok){let u=d?.error||c.status;return clearTimeout(i),Promise.reject(u)}return clearTimeout(i),d}catch(c){this.handleApiError(c,t)}}}handleApiError(t,e){if(!t.response)throw new Error(`Request error on url [${e}]: [${t.toString()}]`);let n=t.response.data,s=n.error||n.message||JSON.stringify(n);throw new Error(s)}async sendTransaction(t){let e=T.transactionToPlainObject(t);return(await this.apiPost("transactions",e)).txHash}async getAccount(t){let e=await this.apiGet(`accounts/${t}`);return{address:e?.address||"",nonce:Number(e?.nonce||0),balance:e?.balance,code:e?.code||"",userName:e?.username||""}}async getGuardianData(t){let e=await this.apiGet(`address/${t}/guardian-data`);return{guarded:e?.data?.guardianData?.guarded||!1,activeGuardian:e?.data?.guardianData?.activeGuardian,pendingGuardian:e?.data?.guardianData?.pendingGuardian}}async getTransaction(t){let e=await this.apiGet(`transactions/${t}`),n=new J(e.status);return{hash:t,type:e.type||"",nonce:e.nonce||0,round:e.round,epoch:e.epoch||0,value:(e.value||0).toString(),sender:e.sender,receiver:e.receiver,gasPrice:e.gasPrice||0,gasLimit:e.gasLimit||0,data:S(e.data||""),status:n,timestamp:e.timestamp||0,blockNonce:e.blockNonce||0,hyperblockNonce:e.hyperblockNonce||0,hyperblockHash:e.hyperblockHash||"",receipt:e.receipt,logs:e.logs,contractResults:e.results||[],isCompleted:!n.isPending()}}async queryContract({address:t,func:e,args:n,value:s,caller:i}){try{let o={scAddress:t,caller:i,funcName:e,value:s,args:()=>n?.map(d=>W(d))},c=await this.apiPost("query",o);return{returnData:c.returnData,returnCode:c.returnCode,returnMessage:c.returnMessage}}catch(o){this.handleApiError(o,"query")}}};var bt=(g=>(g.onLoginStart="onLoginStart",g.onLoginSuccess="onLoginSuccess",g.onLoginFailure="onLoginFailure",g.onLogoutStart="onLogoutStart",g.onLogoutSuccess="onLogoutSuccess",g.onLogoutFailure="onLogoutFailure",g.onQrPending="onQrPending",g.onQrLoaded="onQrLoaded",g.onTxStart="onTxStart",g.onTxSent="onTxSent",g.onTxFinalized="onTxFinalized",g.onTxFailure="onTxFailure",g.onSignMsgStart="onSignMsgStart",g.onSignMsgFinalized="onSignMsgFinalized",g.onSignMsgFailure="onSignMsgFailure",g.onQueryStart="onQueryStart",g.onQueryFinalized="onQueryFinalized",g.onQueryFailure="onQueryFailure",g))(bt||{}),at=(o=>(o.ledger="ledger",o.mobile="mobile",o.webWallet="web-wallet",o.browserExtension="browser-extension",o.xAlias="x-alias",o.xPortalHub="x-portal-hub",o))(at||{}),_t=(e=>(e.mvx_cancelAction="mvx_cancelAction",e.mvx_signNativeAuthToken="mvx_signNativeAuthToken",e))(_t||{}),Ft=(t=>(t.hasWebWalletGuardianSign="hasWebWalletGuardianSign",t))(Ft||{});var a=class{static set(t,e){if(!t)return;let n={...this.events,[t]:e};this.events=n}static get(t){if(!(!t||!this.events))return this.events[t]}static run(t,...e){!t||!this.events||this.events[t]?.(...e)}static clear(){this.events=void 0}};var p=r=>typeof r=="string"?r.toUpperCase():r instanceof Error?r.message:JSON.stringify(r);var vt=async r=>{if(!r.dappProvider)throw new Error("Logout failed: There is no active session!");a.run("onLogoutStart");try{let t=await r.dappProvider.logout();return t&&(l.clear(),a.run("onLogoutSuccess")),t}catch(t){let e=p(t);console.warn(`Something went wrong trying to logout the user: ${e}`),a.run("onLogoutFailure",e)}};var Y=()=>new Date().setHours(new Date().getHours()+24),Z=r=>Date.now()>r;var F=async r=>{let t=l.get("address"),e=l.get("expires");if(!(e&&Z(e))&&t&&r.networkProvider){let s=new b(t);try{let i=await r.networkProvider.getAccount(t),o=await r.networkProvider.getGuardianData(t);l.set("address",t),l.set("activeGuardian",o.guarded&&o.activeGuardian?.address?o.activeGuardian.address:""),l.set("nonce",i.nonce.valueOf()),l.set("balance",i.balance.toString()),s.update(i)}catch(i){let o=p(i);console.warn(`Something went wrong trying to synchronize the user account: ${o}`)}}};var St=async(r,t,e,n="/")=>{let s=await K(),o={callbackUrl:encodeURIComponent(`${window.location.origin}${n}`),token:t};try{if(s&&!await s.login(o))throw new Error("There were problems while logging in!")}catch(u){let f=p(u);throw new Error(f)}if(!s)throw new Error("There were problems with auth provider initialization!");let c=s.getAccount();l.set("loginToken",t);let d=c?.signature;if(d&&l.set("signature",d),r.networkProvider&&d)try{let u=await s.getAddress();if(!u)throw new Error("Canceled!");l.set("address",u),l.set("loginMethod","browser-extension"),l.set("expires",Y()),await F(r);let f=e.getToken(u,t,d);return l.set("accessToken",f),a.run("onLoginSuccess"),s}catch(u){throw new Error(`Something went wrong trying to synchronize the user account: ${u?.message}`)}};var At=async(r,t,e,n)=>{let s=new m(`${r}${A}`),o={callbackUrl:typeof window<"u"?encodeURIComponent(`${window.location.origin}${n||"/"}`):"/",token:t};try{return l.set("loginMethod",x[e].xAliasAddress===r?"x-alias":"web-wallet"),await s.login(o),l.set("expires",Y()),l.set("loginToken",t),s}catch(c){let d=p(c);console.warn(`Something went wrong trying to login the user: ${d}`),l.set("loginMethod",""),a.run("onLoginFailure",d)}};var tt=async(r,t,e)=>{a.run("onTxSent",r);let s=await new _(e).awaitCompleted(t),i=s.sender,o=new b(i),c=await e.getAccount(i);o.update(c),l.set("address",o.bech32()),l.set("balance",o.balance),a.run("onTxFinalized",s)};var et=r=>{let t=r.sender,e=new b(t),n=r.nonce.valueOf();e.incrementNonce(),l.set("nonce",(n+1n).toString())};var Pt=async(r,t,e,n)=>{if(h(N)===$&&r&&t){let i=l.get("activeGuardian"),o=l.get("loginMethod"),c=h("hasWebWalletGuardianSign"),d;if("getTransactionsFromWalletUrl"in r){if(d=r.getTransactionsFromWalletUrl()?.[0],!d)return;o==="web-wallet"&&(d.data=L(d.data))}else i&&o!=="web-wallet"&&o!=="x-alias"&&c&&(d=new m(`${e}${A}`).getTransactionsFromWalletUrl()?.[0]);if(d){let u=T.plainObjectToTransaction(d);u.nonce=BigInt(n),et(u);try{a.run("onTxStart",u);let f=await t.sendTransaction(u);await tt(u,f,t)}catch(f){let lt=`Getting transaction information failed! ${p(f)}`;throw a.run("onTxFailure",u,lt),new Error(lt)}finally{window.history.replaceState(null,"",window.location.pathname)}}window.history.replaceState(null,"",window.location.pathname)}};var It=r=>{let t=l.get("activeGuardian");return t&&(r.version=2,r.options=2,r.guardian=t),r},Lt=async(r,t)=>{let e=new m(`${t}${A}`),n=window?.location.href,s=new URL(n);s.searchParams.set("hasWebWalletGuardianSign","true"),await e.guardTransactions([r],{callbackUrl:encodeURIComponent(s.toString())})},Ut=r=>{let t=l.get("activeGuardian");return!(!l.get("address")||!t||r.isGuardedTransaction())};var Et=()=>{let r=!h("walletProviderStatus"),t=h("status")==="signed",e=h("message"),n=h("signature");r&&t&&e&&n&&(a.run("onSignMsgFinalized",e,n),window.history.replaceState(null,"",window.location.pathname))};var kt=r=>{r.onLoginStart&&a.set("onLoginStart",r.onLoginStart),r.onLoginSuccess&&a.set("onLoginSuccess",r.onLoginSuccess),r.onLoginFailure&&a.set("onLoginFailure",r.onLoginFailure),r.onLogoutStart&&a.set("onLogoutStart",r.onLogoutStart),r.onLogoutSuccess&&a.set("onLogoutSuccess",r.onLogoutSuccess),r.onLogoutFailure&&a.set("onLogoutFailure",r.onLogoutFailure),r.onQrPending&&a.set("onQrPending",r.onQrPending),r.onQrLoaded&&a.set("onQrLoaded",r.onQrLoaded),r.onTxStart&&a.set("onTxStart",r.onTxStart),r.onTxSent&&a.set("onTxSent",r.onTxSent),r.onTxFinalized&&a.set("onTxFinalized",r.onTxFinalized),r.onTxFailure&&a.set("onTxFailure",r.onTxFailure),r.onSignMsgStart&&a.set("onSignMsgStart",r.onSignMsgStart),r.onSignMsgFinalized&&a.set("onSignMsgFinalized",r.onSignMsgFinalized),r.onSignMsgFailure&&a.set("onSignMsgFailure",r.onSignMsgFailure),r.onQueryStart&&a.set("onQueryStart",r.onQueryStart),r.onQueryFinalized&&a.set("onQueryFinalized",r.onQueryFinalized),r.onQueryFailure&&a.set("onQueryFailure",r.onQueryFailure)};var rt=async r=>{a.run("onLoginStart");try{await r(()=>{a.run("onLoginSuccess")})}catch(t){let e=p(t);console.warn(`Something went wrong trying to login the user: ${e}`),a.run("onLoginFailure",e)}};var ct=class{static async init(t){let e=l.get();if(e.expires&&Z(e.expires)){l.clear(),this.dappProvider=void 0;return}this.initOptions={chainType:q,apiUrl:Tt,apiTimeout:1e4,walletConnectV2ProjectId:"",walletConnectV2RelayAddresses:xt,...t},this.networkProvider=new X(this.initOptions),kt(this.initOptions),h("accessToken")&&await rt(async i=>{await F(this),i()}),(e?.address||(e.loginMethod==="web-wallet"||e.loginMethod==="x-alias")&&h("address"))&&e?.loginMethod&&(await rt(async i=>{e.loginMethod==="browser-extension"&&(this.dappProvider=await K()),e.loginMethod==="web-wallet"&&this.initOptions?.chainType&&(this.dappProvider=await yt(x[this.initOptions.chainType].walletAddress,this.initOptions.apiUrl)),await F(this),i()}),this.initOptions?.chainType&&(await Pt(this.dappProvider,this.networkProvider,x[this.initOptions.chainType][e.loginMethod==="x-alias"?"xAliasAddress":"walletAddress"],e.nonce),Et()))}static async login(t,e){if(!Object.values(at).includes(t)){let s="Wrong login method!";throw a.run("onLoginFailure",s),new Error(s)}if(!this.networkProvider){let s="Login failed: Use ElvenJs.init() first!";throw a.run("onLoginFailure",s),new Error(s)}await rt(async()=>{let s=new k({apiUrl:this.initOptions?.apiUrl,origin:window.location.origin}),i=await s.initialize();if(t==="browser-extension"){let o=await St(this,i,s,e?.callbackRoute);this.dappProvider=o}if(t==="web-wallet"&&this.initOptions?.chainType){let o=await At(x[this.initOptions.chainType].walletAddress,i,this.initOptions?.chainType,e?.callbackRoute);this.dappProvider=o}})}static async logout(){try{let t=await vt(this);return this.dappProvider=void 0,t}catch(t){let e=p(t);console.warn("Something went wrong when logging out: ",e)}}static async signAndSendTransaction(t){if(!this.dappProvider){let n="Transaction signing failed: There is no active session!";throw a.run("onTxFailure",t,n),new Error(n)}if(!this.networkProvider){let n="Transaction signing failed: There is no active network provider!";throw a.run("onTxFailure",t,n),new Error(n)}let e=It(t);try{a.run("onTxStart",t);let n=l.get();if(t.nonce=n.nonce,this.dappProvider instanceof I&&(e=await this.dappProvider.signTransaction(t)),this.dappProvider instanceof m&&await this.dappProvider.signTransaction(t),n.loginMethod!=="web-wallet"&&n.loginMethod!=="x-alias"){let s=Ut(e);if(s||et(e),s&&this.initOptions?.chainType){await Lt(e,x[this.initOptions.chainType].walletAddress);return}let i=await this.networkProvider.sendTransaction(e);await tt(e,i,this.networkProvider)}}catch(n){let s=p(n);throw a.run("onTxFailure",e,`Getting transaction information failed! ${s}`),new Error(`Getting transaction information failed! ${s}`)}return e}static async signMessage(t,e){if(!this.dappProvider){let s="Message signing failed: There is no active session!";throw a.run("onSignMsgFailure",t,s),new Error(s)}if(!this.networkProvider){let s="Message signing failed: There is no active network provider!";throw a.run("onSignMsgFailure",t,s),new Error(s)}let n="";try{if(a.run("onSignMsgStart",t),this.dappProvider instanceof I){let i=await this.dappProvider.signMessage(new v({data:D(t)}));i?.signature&&(n=y(i.signature))}if(this.dappProvider instanceof m){let i=c=>encodeURIComponent(c).replace(/[!'()*]/g,d=>`%${d.charCodeAt(0).toString(16).toUpperCase()}`),o=e?.callbackUrl||window.location.origin;await this.dappProvider.signMessage(new v({data:D(t)}),{callbackUrl:encodeURIComponent(`${o}${o.includes("?")?"&":"?"}message=${i(t)}`)})}let s=l.get();return s.loginMethod!=="web-wallet"&&s.loginMethod!=="x-alias"&&a.run("onSignMsgFinalized",t,n),{message:t,messageSignature:n}}catch(s){let i=p(s);throw a.run("onSignMsgFailure",t,i),new Error(`Message signing failed! ${i}`)}}static async queryContract({address:t,func:e,args:n=[],value:s=0,caller:i}){if(!this.networkProvider)throw new Error("Query failed: There is no active network provider!");if(!t||!e)throw new Error("Query failed: The Query arguments are not valid! Address and func required");let o={address:t,func:e,args:n,value:s,caller:i};try{a.run("onQueryStart",o);let c=await this.networkProvider.queryContract(o);return a.run("onQueryFinalized",c),c}catch(c){let d=p(c);throw a.run("onQueryFinalized",o,d),new Error(`Smart contract query failed! ${d}`)}}static{this.storage=l}static{this.destroy=()=>{this.networkProvider=void 0,this.dappProvider=void 0,this.initOptions=void 0,a.clear()}}};var Dt=({amount:r,decimals:t})=>{if(t<0)throw new Error("Decimal places shouldn't be negative number!");let e=r.toString().replace(/,/g,""),[n,s=""]=e.split("."),i=n+s.padEnd(t,"0");return i=i.substring(0,n.length+t),BigInt(i)},Nt=({amount:r,decimals:t,rounding:e=t})=>{if(t<0)throw new Error("Decimal places shouldn't be negative number!");let n=BigInt(r)<0n,s=BigInt(r).toString();n&&(s=s.slice(1)),s=s.padStart(t+1,"0");let i=s.slice(0,-t),o=s.slice(-t);if(e<t){let d=parseInt(o.charAt(e),10);if(o=o.slice(0,e),d>=5){let u=BigInt("1"+"0".repeat(t-e)),f=BigInt(r)+u;return n&&(f=-f),Nt({amount:f,decimals:t,rounding:e})}}let c=`${i}.${o.padEnd(e,"0")}`;return c=c.replace(/\.?0+$/,""),n&&(c=`-${c}`),c};export{b as Account,_t as DappCoreWCV2CustomMethodsEnum,ct as ElvenJS,bt as EventStoreEvents,at as LoginMethodsEnum,R as Transaction,_ as TransactionWatcher,Ft as WebWalletUrlParamsEnum,Nt as formatAmount,Dt as parseAmount};
