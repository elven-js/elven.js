/*!
 * Portions of this code are derived from MultiversX libraries.
 * These portions are licensed under the MIT License.
 *
 * See the MultiversX repository for details: https://github.com/multiversx
 * See the attached MIT licence for elven.js: https://github.com/elven-js/elven.js/blob/main/LICENSE
 */

var ot=Object.defineProperty;var st=(n,e)=>{for(var t in e)ot(n,t,{get:e[t],enumerable:!0})};var D="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Ne=new Uint8Array(256);for(let n=0;n<D.length;n++)Ne[D.charCodeAt(n)]=n;var at=new TextEncoder,ct=new TextDecoder,Oe=n=>/^[0-9a-fA-F]{64}$/.test(n),L=n=>at.encode(n),N=n=>ct.decode(n),A=n=>{if(!/^[0-9a-fA-F]+$/.test(n)||n.length%2!==0)throw new Error("Invalid hex string");let e=new Uint8Array(n.length/2);for(let t=0;t<e.length;t++)e[t]=parseInt(n.substr(t*2,2),16);return e},b=n=>Array.from(n).map(e=>e.toString(16).padStart(2,"0")).join(""),Ue=n=>b(L(n)),k=n=>{n=n.replace(/[^A-Za-z0-9+/=]/g,"");let e=0;n.endsWith("==")?e=2:n.endsWith("=")&&(e=1);let t=Math.floor(n.length*6/8-e),r=new Uint8Array(t),o=0,i=0,s=0;for(let c=0;c<n.length;c++){let l=n.charAt(c);if(l==="=")break;o=o<<6|Ne[l.charCodeAt(0)],i+=6,i>=8&&(i-=8,r[s++]=o>>i&255)}return r},dt=n=>{let e="",t=n.length;for(let r=0;r<t;r+=3){let o=n[r],i=r+1<t?n[r+1]:0,s=r+2<t?n[r+2]:0,c=o<<16|i<<8|s,l=c>>18&63,g=c>>12&63,T=c>>6&63,Ie=c&63;e+=D.charAt(l),e+=D.charAt(g),e+=r+1<t?D.charAt(T):"=",e+=r+2<t?D.charAt(Ie):"="}return e},z=n=>N(k(n)),R=n=>{let e=typeof n=="string"?L(n):n;return dt(e)};function lt(n){let e=[],t=/([^[\]]+)|\[(.*?)\]/g,r;for(;(r=t.exec(n))!==null;)r[1]!==void 0?e.push(r[1]):r[2]!==void 0&&(r[2]===""?e.push(""):/^\d+$/.test(r[2])?e.push(Number(r[2])):e.push(r[2]));return e}function ut(n,e,t){let r=n;for(let o=0;o<e.length;o++){let i=e[o];if(o===e.length-1)i===""?(Array.isArray(r)||(r=[]),r.push(t)):(typeof i=="number"&&(Array.isArray(r)||(r=[])),r[i]=t);else{let s=e[o+1];i===""?(Array.isArray(r)||(r=[]),(r.length===0||typeof r[r.length-1]!="object")&&r.push(typeof s=="number"?[]:{}),r=r[r.length-1]):typeof i=="number"?(Array.isArray(r)||(r=[]),r[i]||(r[i]=typeof s=="number"?[]:{}),r=r[i]):(r[i]||(r[i]=typeof s=="number"||s===""?[]:{}),r=r[i])}}}function he(n,e,t){if(e!=null)if(typeof e=="object")if(Array.isArray(e))e.forEach(r=>{he([...n,""],r,t)});else for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&he([...n,r],e[r],t);else{let r=n.map((o,i)=>i===0?encodeURIComponent(String(o)):o===""?"[]":`[${encodeURIComponent(String(o))}]`).join("");t.push(`${r}=${encodeURIComponent(e)}`)}}function Te(n){let e=new URLSearchParams(n),t={};for(let[r,o]of e.entries()){let i=lt(r);ut(t,i,o)}return t}function ke(n){let e=[];return he([],n,e),e.join("&")}var gt=()=>typeof window<"u"&&typeof window.location<"u",Q=()=>{if(gt()){let n=window.location.ancestorOrigins;return n?.[n.length-1]??"*"}return"*"},we=()=>{let n=window;return!!(n?.ReactNativeWebView||n?.webkit)};var I=class{constructor(e){this.address=new Uint8Array([]);this.nonce=0;this.balance="0";Oe(e)&&(this.address=A(e))}update(e){this.nonce=e.nonce,this.balance=e.balance}incrementNonce(){this.nonce=this.nonce+1}getNonceThenIncrement(){let e=this.nonce;return this.nonce=this.nonce+1,e}toJSON(){return{address:b(this.address),nonce:this.nonce,balance:this.balance}}bech32(){return b(this.address)}};var Me=1e9,We=0,X=2,_e=2,ye=64,De=1;var Fe="sdk-js";var Ge="hook/login",$e="hook/logout";var He="hook/sign",Be="hook/2fa",qe="hook/sign-message",j="walletProviderStatus",Y="transactionsSigned";var ze={SIGN_TRANSACTIONS_REQUEST:"SIGN_TRANSACTIONS_RESPONSE",GUARD_TRANSACTIONS_REQUEST:"GUARD_TRANSACTIONS_RESPONSE",SIGN_MESSAGE_REQUEST:"SIGN_MESSAGE_RESPONSE",LOGIN_REQUEST:"LOGIN_RESPONSE",LOGOUT_REQUEST:"DISCONNECT_RESPONSE",CANCEL_ACTION_REQUEST:"CANCEL_RESPONSE",FINALIZE_HANDSHAKE_REQUEST:"NONE_RESPONSE",FINALIZE_RESET_STATE_REQUEST:"RESET_STATE_RESPONSE"};var C=class{constructor(e){this.nonce=BigInt(e.nonce?.valueOf()||0n),this.value=e.value??0n,this.sender=this.addressAsBech32(e.sender),this.receiver=this.addressAsBech32(e.receiver),this.senderUsername=e.senderUsername||"",this.receiverUsername=e.receiverUsername||"",this.gasPrice=BigInt(e.gasPrice?.valueOf()||Me),this.gasLimit=BigInt(e.gasLimit.valueOf()),this.data=e.data?.valueOf()||new Uint8Array,this.chainID=e.chainID.valueOf(),this.version=Number(e.version?.valueOf()||X),this.options=Number(e.options?.valueOf()||We),this.guardian=e.guardian?this.addressAsBech32(e.guardian):"",this.signature=e.signature||new Uint8Array([]),this.guardianSignature=e.guardianSignature||new Uint8Array([])}addressAsBech32(e){return e}isGuardedTransaction(){let e=this.guardian.length>0,t=this.guardianSignature.length>0;return e&&t}};var S=class extends Error{constructor(t,r){super(t);this.inner=void 0;this.inner=r}summary(){let t=[];t.push({name:this.name,message:this.message});let r=this.inner;for(;r;)t.push({name:r.name,message:r.message}),r=r.inner;return t}};var Z=class extends S{constructor(){super("Async timer already running")}},ee=class extends S{constructor(){super("Async timer aborted")}};var F=class extends S{constructor(){super("Expected transaction status not reached")}},K=class extends S{constructor(){super("Expected transaction events not found")}};var te=class extends S{constructor(){super("The transaction watcher requires the `isCompleted` property to be defined on the transaction object. Perhaps you've used the sdk-network-provider's `ProxyNetworkProvider.getTransaction()` and in that case you should also pass `withProcessStatus=true`.")}};var ne=class extends S{constructor(){super("Cannot sign single transaction.")}},re=class extends S{constructor(){super("Account is not connected.")}},V=class extends Error{constructor(){super("Cannot get signed transaction(s)")}},ie=class extends Error{constructor(){super("Cannot get signed message")}};var G=class{constructor(e){this.timeoutHandle=null;this.rejectionFunc=null;this.name=e,this.correlationTag=0}start(e){if(this.timeoutHandle)throw new Z;return this.correlationTag++,new Promise((t,r)=>{this.rejectionFunc=r;let o=()=>{this.rejectionFunc=null,this.stop(),t()};this.timeoutHandle=setTimeout(o,e)})}abort(){this.rejectionFunc&&(this.rejectionFunc(new ee),this.rejectionFunc=null),this.stop()}stop(){this.isStopped()||this.timeoutHandle&&(clearTimeout(this.timeoutHandle),this.timeoutHandle=null)}isStopped(){return!this.timeoutHandle}};var ve=class{constructor(e){this.fetcher=e}async getTransaction(e){return await this.fetcher.getTransaction(e)}},J=class n{static{this.DefaultPollingInterval=6e3}static{this.DefaultTimeout=n.DefaultPollingInterval*15}static{this.DefaultPatience=0}static{this.NoopOnStatusReceived=()=>{}}constructor(e,t={}){this.fetcher=new ve(e),this.pollingIntervalMilliseconds=t.pollingIntervalMilliseconds||n.DefaultPollingInterval,this.timeoutMilliseconds=t.timeoutMilliseconds||n.DefaultTimeout,this.patienceMilliseconds=t.patienceMilliseconds||n.DefaultPatience}async awaitPending(e){let t=i=>i.status.isPending(),r=async()=>{let i=this.transactionOrTxHashToTxHash(e);return await this.fetcher.getTransaction(i)},o=()=>new F;return this.awaitConditionally(t,r,o)}async awaitCompleted(e){let t=i=>{if(i.isCompleted===void 0)throw new te;return i.isCompleted},r=async()=>{let i=this.transactionOrTxHashToTxHash(e);return await this.fetcher.getTransaction(i)},o=()=>new F;return this.awaitConditionally(t,r,o)}async awaitAllEvents(e,t){let r=s=>{let c=this.getAllTransactionEvents(s).map(g=>g.identifier);return t.every(g=>c.includes(g))},o=async()=>{let s=this.transactionOrTxHashToTxHash(e);return await this.fetcher.getTransaction(s)},i=()=>new K;return this.awaitConditionally(r,o,i)}async awaitAnyEvent(e,t){let r=s=>{let c=this.getAllTransactionEvents(s).map(g=>g.identifier);return t.find(g=>c.includes(g))!=null},o=async()=>{let s=this.transactionOrTxHashToTxHash(e);return await this.fetcher.getTransaction(s)},i=()=>new K;return this.awaitConditionally(r,o,i)}async awaitOnCondition(e,t){let r=async()=>{let i=this.transactionOrTxHashToTxHash(e);return await this.fetcher.getTransaction(i)},o=()=>new F;return this.awaitConditionally(t,r,o)}transactionOrTxHashToTxHash(e){let t=typeof e=="string"?e:e.getHash().hex();if(t.length!==ye)throw new S(`Invalid transaction hash length. The length of a hex encoded hash should be ${ye}.`);return t}async awaitConditionally(e,t,r){let o=new G("watcher:periodic"),i=new G("watcher:patience"),s=new G("watcher:timeout"),c=!1,l,g=!1;for(s.start(this.timeoutMilliseconds).finally(()=>{s.stop(),c=!0});!c&&(await o.start(this.pollingIntervalMilliseconds),l=await t(),g=e(l),!(g||c)););if(g&&await i.start(this.patienceMilliseconds),s.isStopped()||s.stop(),!l||!g)throw r();return l}getAllTransactionEvents(e){let t=[...e.logs.events];for(let r of e.contractResults.items)t.push(...r.logs.events);return t}};var x=class{constructor(e){this.data=e.data,this.signature=e.signature,this.address=e.address,this.version=e.version||De,this.signer=e.signer||Fe}};var h=class{static transactionToPlainObject(e){return{nonce:Number(e.nonce),value:e.value.toString(),receiver:e.receiver,sender:e.sender,senderUsername:e.senderUsername?R(e.senderUsername):void 0,receiverUsername:e.receiverUsername?R(e.receiverUsername):void 0,gasPrice:Number(e.gasPrice),gasLimit:Number(e.gasLimit),data:e.data&&e.data.length?R(e.data):void 0,chainID:e.chainID,version:e.version,options:e.options==0?void 0:e.options,guardian:e.guardian?e.guardian:void 0,signature:e.signature&&e.signature.length?b(e.signature):void 0,guardianSignature:e.guardianSignature&&e.guardianSignature.length?b(e.guardianSignature):void 0}}static plainObjectToTransaction(e){return new C({nonce:BigInt(e.nonce),value:BigInt(e.value||""),receiver:e.receiver,receiverUsername:z(e.receiverUsername||""),sender:e.sender,senderUsername:z(e.senderUsername||""),guardian:e.guardian,gasPrice:BigInt(e.gasPrice),gasLimit:BigInt(e.gasLimit),data:e.data?k(e.data):void 0,chainID:e.chainID,version:Number(e.version),options:Number(e.options),signature:e.signature?A(e.signature):void 0,guardianSignature:e.guardianSignature?A(e.guardianSignature):void 0})}};var M=class n{constructor(){this.account={address:""};this.initialized=!1;if(n._instance)throw new Error("Error: Instantiation failed: Use ExtensionProvider.getInstance() instead of new.");n._instance=this}static{this._instance=new n}static getInstance(){return n._instance}setAddress(e){return this.account.address=e,n._instance}async init(){return window&&window.elrondWallet&&(this.initialized=!0),this.initialized}async login(e={}){if(!this.initialized)throw new Error("Extension provider is not initialised, call init() first");let{token:t}=e,r=t||"";return await this.startBgrMsgChannel("connect",r),this.account}async logout(){if(!this.initialized)throw new Error("Extension provider is not initialised, call init() first");try{await this.startBgrMsgChannel("logout",this.account.address),this.disconnect()}catch(e){console.warn("Extension origin url is already cleared!",e)}return!0}disconnect(){this.account={address:""}}async getAddress(){if(!this.initialized)throw new Error("Extension provider is not initialised, call init() first");return this.account?this.account.address:""}isInitialized(){return this.initialized}isConnected(){return!!this.account.address}getAccount(){return this.account}setAccount(e){this.account=e}async signTransaction(e){this.ensureConnected();let t=await this.signTransactions([e]);if(t.length!=1)throw new ne;return t[0]}ensureConnected(){if(!this.account.address)throw new re}async signTransactions(e){this.ensureConnected();let t=await this.startBgrMsgChannel("signTransactions",{from:this.account.address,transactions:e.map(r=>h.transactionToPlainObject(r))});try{return t.map(o=>h.plainObjectToTransaction(o))}catch(r){throw new Error(`Transaction canceled: ${r.message}.`)}}async signMessage(e){this.ensureConnected();let t={account:this.account.address,message:N(e.data)},o=(await this.startBgrMsgChannel("signMessage",t)).signature,i=A(o);return new x({data:e.data,address:e.address??this.account.address,signer:"extension",version:e.version,signature:i})}cancelAction(){return this.startBgrMsgChannel("cancelAction",{})}startBgrMsgChannel(e,t){return new Promise(r=>{window.postMessage({target:"erdw-inpage",type:e,data:t},window.origin);let o=i=>{i.isTrusted&&i.data.target==="erdw-contentScript"&&(i.data.type==="connectResponse"?(i.data.data&&i.data.data.address&&(this.account=i.data.data),window.removeEventListener("message",o),r(i.data.data)):(window.removeEventListener("message",o),r(i.data.data)))};window.addEventListener("message",o,!1)})}};var oe="elvenjs_state",Qe="https://devnet-api.multiversx.com";var O="/dapp/init",se="devnet";var y={devnet:{id:"devnet",shortId:"D",name:"Devnet",egldLabel:"xEGLD",egldDenomination:"18",decimals:"4",gasPerDataByte:"1500",walletAddress:"https://devnet-wallet.multiversx.com",xAliasAddress:"https://devnet.xalias.com",apiAddress:"https://devnet-api.multiversx.com",explorerAddress:"https://devnet-explorer.multiversx.com",apiTimeout:1e4},testnet:{id:"testnet",shortId:"T",name:"Testnet",egldLabel:"xEGLD",egldDenomination:"18",decimals:"4",gasPerDataByte:"1500",walletAddress:"https://testnet-wallet.multiversx.com",xAliasAddress:"https://testnet.xalias.com",apiAddress:"https://testnet-api.multiversx.com",explorerAddress:"https://testnet-explorer.multiversx.com",apiTimeout:1e4},mainnet:{id:"mainnet",shortId:"1",name:"Mainnet",egldLabel:"EGLD",egldDenomination:"18",decimals:"4",gasPerDataByte:"1500",walletAddress:"https://wallet.multiversx.com",xAliasAddress:"https://xalias.com",apiAddress:"https://api.multiversx.com",explorerAddress:"https://explorer.multiversx.com",apiTimeout:1e4}};var d={get(n){let e=localStorage.getItem(oe);if(!e)return{};let t=JSON.parse(e);return n?t[n]:t},set(n,e){let t=this.get();t[n]=e,localStorage.setItem(oe,JSON.stringify(t))},clear(){localStorage.removeItem(oe)}};var ae=async()=>{let n=M.getInstance();try{let e=await n.init(),t=d.get();if(t?.address&&n.setAddress(t.address),!e){console.warn("Something went wrong when trying to initialize the ExtensionProvider..");return}return n}catch{console.warn("Can't initialize the Dapp Provider!")}};var be=class{constructor(e){this.nonce=0;this.value="";this.receiver="";this.sender="";this.gasPrice=0;this.gasLimit=0;this.data="";this.chainID="";this.version=0;this.signature="";Object.assign(this,e)}},v=class n{constructor(e){this.walletUrl=e}async login(e){let t=this.buildWalletUrl({endpoint:Ge,callbackUrl:e?.callbackUrl,params:{token:e?.token}});return await this.redirect(t,e?.redirectDelayMilliseconds),t}async redirect(e,t){t?await this.redirectLater(e,t):this.redirectImmediately(e)}redirectImmediately(e){window.location.href=e}async redirectLater(e,t){await new Promise(r=>{setTimeout(()=>{window.location.href=e,r(!0)},t)})}async logout(e){let t=this.buildWalletUrl({endpoint:$e,callbackUrl:e?.callbackUrl});return await this.redirect(t,e?.redirectDelayMilliseconds),!0}async signMessage(e,t){let r=this.buildWalletUrl({endpoint:qe,callbackUrl:t?.callbackUrl,params:{message:N(e.data)}});return await this.redirect(r),r}getMessageSignatureFromWalletUrl(){let e=window.location.search.slice(1);console.info("getMessageSignatureFromWalletUrl(), url:",e);let t=Te(e);if((t.status?.toString()||"")!=="signed")throw new ie;return t.signature?.toString()||""}async guardTransactions(e,t){this.redirectTransactionsToEndpoint(Be,e,t)}async signTransactions(e,t){this.redirectTransactionsToEndpoint(He,e,t)}async signTransaction(e,t){await this.signTransactions([e],t)}getTransactionsFromWalletUrl(e=window.location.search){let t=Te(e.slice(1));return n.isTxSignReturnSuccess(t)?this.getTxSignReturnValue(t):[]}static isTxSignReturnSuccess(e){return Object.prototype.hasOwnProperty.call(e,j)&&e[j]===Y}getTxSignReturnValue(e){console.info("getTxSignReturnValue(), urlParams:",e);let t=["nonce","value","receiver","sender","gasPrice","gasLimit","chainID","version","signature"];for(let i of t)if(!e[i]||!Array.isArray(e[i]))throw new V;let r=e.nonce.length;for(let i of t)if(e[i].length!==r)throw new V;let o=[];for(let i=0;i<r;i++){let s=new be({nonce:parseInt(e.nonce[i]),value:e.value[i],receiver:e.receiver[i],sender:e.sender[i],gasPrice:parseInt(e.gasPrice[i]),gasLimit:parseInt(e.gasLimit[i]),data:e.data&&e.data[i]?e.data[i]:"",chainID:e.chainID[i],version:parseInt(e.version[i]),...e.guardian&&e.guardian[i]?{guardian:e.guardian[i]}:{},...e.guardianSignature&&e.guardianSignature[i]?{guardianSignature:e.guardianSignature[i]}:{},...e.options&&e.options[i]?{options:parseInt(e.options[i])}:{},...e.senderUsername&&e.senderUsername[i]?{senderUsername:e.senderUsername[i]}:{},...e.receiverUsername&&e.receiverUsername[i]?{receiverUsername:e.receiverUsername[i]}:{},signature:e.signature[i]});o.push(s)}return o}static prepareWalletTransaction(e){let t=h.transactionToPlainObject(e);return t.data?t.data=N(k(t.data)):t.data="",t}buildWalletUrl(e){let t=e?.callbackUrl||window.location.href,r=ke(e.params||{}),o=r?`${r}&callbackUrl=${t}`:`callbackUrl=${t}`,i=`${this.baseWalletUrl()}/${e.endpoint}?${o}`;return console.info(`Redirecting to Wallet URL: ${decodeURI(i)}`),i}baseWalletUrl(){let e=this.walletUrl.split("/"),t=e[0],r=e[2];return t+"//"+r}redirectTransactionsToEndpoint(e,t,r){let o={};t.map(s=>{let c=n.prepareWalletTransaction(s);for(let l in c)Object.prototype.hasOwnProperty.call(c,l)&&!Object.prototype.hasOwnProperty.call(o,l)&&(o[l]=[]),o[l].push(c[l])});let i=this.buildWalletUrl({endpoint:e,callbackUrl:r?.callbackUrl,params:o});window.location.href=i}};var xe=class{constructor(){this.origin=typeof window<"u"&&typeof window.location<"u"?window.location.hostname:"";this.apiUrl="https://api.multiversx.com";this.expirySeconds=60*60*2}},$=class{constructor(e){this.config=Object.assign(new xe,e)}getToken(e,t,r){let o=this.encodeValue(e),i=this.encodeValue(t);return`${o}.${i}.${r}`}async initialize(e={}){let t=await this.getCurrentBlockHash(),r=this.encodeValue(JSON.stringify(e));return`${this.encodeValue(this.config.origin)}.${t}.${this.config.expirySeconds}.${r}`}async getCurrentBlockHash(){return await this.getCurrentBlockHashWithApi()}async getCurrentBlockHashWithApi(){let e=`${this.config.apiUrl}/blocks/latest?ttl=${this.config.expirySeconds}&fields=hash`,t=await this.get(e);return t.hash!==void 0?t.hash:this.getCurrentBlockHashWithApiFallback()}async getCurrentBlockHashWithApiFallback(){let e=`${this.config.apiUrl}/blocks?size=1&fields=hash`;return this.config.blockHashShard!==void 0&&(e+=`&shard=${this.config.blockHashShard}`),(await this.get(e)).hash}encodeValue(e){return this.escape(R(e))}escape(e){return e.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}async get(e){try{let t=await fetch(e,{method:"GET",headers:this.config.extraRequestHeaders});if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);return await t.json()}catch(t){throw console.error("There was a problem with the fetch operation:",t),t}}};var ce=(n,e)=>t=>{let r=t.data;try{r=we()&&typeof r=="string"?JSON.parse(r):r}catch{console.error("error parsing eventData",r)}let{type:o,payload:i}=r;!we()&&t.origin!=Q()||!(n===o||o==="CANCEL_RESPONSE")||(typeof window<"u"&&window.removeEventListener?.("message",ce(n,e)),e({type:o,payload:i}))};var U=class n{constructor(e){this.initialized=!1;this.account={address:""};this.resetState=e=>{typeof window<"u"&&window.addEventListener("message",ce("RESET_STATE_RESPONSE",t=>{t.type==="RESET_STATE_RESPONSE"&&(e?.(),setTimeout(()=>{this.finalizeResetState()},500))}))};this.init=async()=>(await this.sendPostMessage({type:"FINALIZE_HANDSHAKE_REQUEST",payload:void 0}),this.initialized=!0,this.initialized);this.login=async()=>{if(!this.initialized)throw new Error("Provider not initialized");let e=await this.sendPostMessage({type:"LOGIN_REQUEST",payload:void 0});return e.type=="CANCEL_RESPONSE"?(console.warn("Cancelled the login action"),await this.cancelAction(),null):e.payload.data?(this.account=e.payload.data,this.account):(console.error("Error logging in",e.payload.error??"No data received"),null)};this.logout=async()=>{let e=await this.sendPostMessage({type:"LOGOUT_REQUEST",payload:void 0});return this.initialized=!1,this.disconnect(),!!e.payload.data};this.relogin=async()=>{let e=await this.sendPostMessage({type:"LOGIN_REQUEST",payload:void 0});if(e.type=="CANCEL_RESPONSE")return console.warn("Cancelled the re-login action"),await this.cancelAction(),null;if(!e.payload.data)return console.error("Re-login Error",e.payload.error??"No data received"),null;let{data:t,error:r}=e.payload;if(r||!t)throw new Error("Unable to re-login");let{accessToken:o}=t;return o?(this.account=t,o):(console.error("Unable to re-login. Missing accessToken."),null)};this.signTransactions=async e=>{let t=await this.sendPostMessage({type:"SIGN_TRANSACTIONS_REQUEST",payload:e.map(i=>h.transactionToPlainObject(i))}),{data:r,error:o}=t.payload;if(o||!r)throw new Error("Unable to sign transactions");if(t.type=="CANCEL_RESPONSE")throw this.cancelAction(),new Error("Cancelled the transactions signing action");return r.map(i=>h.plainObjectToTransaction(i))};this.signTransaction=async e=>(await this.signTransactions([e]))[0];this.signMessage=async e=>{let t=await this.sendPostMessage({type:"SIGN_MESSAGE_REQUEST",payload:{message:N(e.data)}}),{data:r,error:o}=t.payload;return o||!r?(console.error("Unable to sign message"),null):t.type=="CANCEL_RESPONSE"?(console.warn("Cancelled the message signing action"),this.cancelAction(),null):r.status!=="signed"?(console.error("Could not sign message"),null):new x({data:e.data,address:e.address??this.account.address,signer:"webview",version:e.version,signature:A(r.signature||"")})};this.cancelAction=async()=>this.sendPostMessage({type:"CANCEL_ACTION_REQUEST",payload:void 0});this.finalizeResetState=async()=>this.sendPostMessage({type:"FINALIZE_RESET_STATE_REQUEST",payload:void 0});this.sendPostMessage=async e=>{let t=window;return t&&(t.ReactNativeWebView?t.ReactNativeWebView.postMessage(JSON.stringify(e)):t.webkit?t.webkit.messageHandlers?.jsHandler?.postMessage(JSON.stringify(e),Q()):t.parent&&t.parent.postMessage(e,Q())),await this.waitingForResponse(ze[e.type])};this.waitingForResponse=async e=>await new Promise(t=>{typeof window<"u"&&window.addEventListener?.("message",ce(e,t))});e?.resetStateCallback&&this.resetState(e.resetStateCallback)}static getInstance(e){return n._instance||(n._instance=new n(e)),n._instance}disconnect(){this.account={address:""}}isInitialized(){return this.initialized}isConnected(){return!!this.account.address}getAccount(){return this.account}setAccount(e){this.account=e}};var w=n=>{if(typeof window<"u"){let e=new URL(window.location.href);return new URLSearchParams(e.search).get(n)}};var Se=async(n,e)=>{let t=w("signature"),r=w("address"),o=d.get("address"),i=d.get("loginToken");if(t&&d.set("signature",t),r||o){r&&(d.set("address",r),window.history.replaceState(null,"",window.location.pathname));let s=new v(`${n}${O}`);if(t&&e&&r){let l=new $({apiUrl:e,origin:window.location.origin}).getToken(r,i,t);d.set("accessToken",l)}return s}};var de=class n{constructor(e){this.status=(e||"").toLowerCase()}static createUnknown(){return new n("unknown")}isPending(){return this.status=="received"||this.status=="pending"}isExecuted(){return this.isSuccessful()||this.isFailed()||this.isInvalid()}isSuccessful(){return this.status=="executed"||this.status=="success"||this.status=="successful"}isFailed(){return this.status=="fail"||this.status=="failed"||this.status=="unsuccessful"||this.isInvalid()}isInvalid(){return this.status=="invalid"}toString(){return this.status}valueOf(){return this.status}equals(e){return e?this.status==e.status:!1}};var le=class{constructor({apiUrl:e,chainType:t,apiTimeout:r}){this.chainType=t||se,this.apiUrl=e||y[this.chainType]?.apiAddress,this.apiTimeout=r||y[this.chainType]?.apiTimeout}async apiGet(e,t){if(typeof fetch<"u"){let r=new AbortController,o=setTimeout(()=>r.abort(),this.apiTimeout),i={method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"},signal:r.signal};try{let s=await fetch(this.apiUrl+"/"+e,Object.assign(i,t||{})),c=await s.json();if(!s.ok){let l=c?.error||s.status;return clearTimeout(o),Promise.reject(l)}return clearTimeout(o),c}catch(s){this.handleApiError(s,e)}}}async apiPost(e,t,r){if(typeof fetch<"u"){let o=new AbortController,i=setTimeout(()=>o.abort(),this.apiTimeout),s={method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(t||{}),signal:o.signal};try{let c=await fetch(this.apiUrl+"/"+e,Object.assign(s,r||{})),l=await c.json();if(!c.ok){let g=l?.error||c.status;return clearTimeout(i),Promise.reject(g)}return clearTimeout(i),l}catch(c){this.handleApiError(c,e)}}}handleApiError(e,t){if(!e.response)throw new Error(`Request error on url [${t}]: [${e.toString()}]`);let r=e.response.data,o=r.error||r.message||JSON.stringify(r);throw new Error(o)}async sendTransaction(e){let t=h.transactionToPlainObject(e);return await this.apiPost("transactions",t)}async getAccount(e){let t=await this.apiGet(`accounts/${e}`);return{address:t?.address||"",nonce:Number(t?.nonce||0),balance:t?.balance,code:t?.code||"",userName:t?.username||""}}async getGuardianData(e){let t=await this.apiGet(`address/${e}/guardian-data`);return{guarded:t?.data?.guardianData?.guarded||!1,activeGuardian:t?.data?.guardianData?.activeGuardian,pendingGuardian:t?.data?.guardianData?.pendingGuardian}}async getTransaction(e){let t=await this.apiGet(`transactions/${e}`),r=new de(t.status);return{hash:e,type:t.type||"",nonce:t.nonce||0,round:t.round,epoch:t.epoch||0,value:(t.value||0).toString(),sender:t.sender,receiver:t.receiver,gasPrice:t.gasPrice||0,gasLimit:t.gasLimit||0,data:k(t.data||""),status:r,timestamp:t.timestamp||0,blockNonce:t.blockNonce||0,hyperblockNonce:t.hyperblockNonce||0,hyperblockHash:t.hyperblockHash||"",receipt:t.receipt,logs:t.logs,contractResults:t.results||[],isCompleted:!r.isPending()}}async queryContract({address:e,func:t,args:r,value:o,caller:i}){try{let s={scAddress:e,caller:i,funcName:t,value:o,args:()=>r?.map(l=>Ue(l))},c=await this.apiPost("query",s);return{returnData:c.returnData,returnCode:c.returnCode,returnMessage:c.returnMessage}}catch(s){this.handleApiError(s,"query")}}};var E=(m=>(m.onLoginStart="onLoginStart",m.onLoginSuccess="onLoginSuccess",m.onLoginFailure="onLoginFailure",m.onLogoutStart="onLogoutStart",m.onLogoutSuccess="onLogoutSuccess",m.onLogoutFailure="onLogoutFailure",m.onQrPending="onQrPending",m.onQrLoaded="onQrLoaded",m.onTxStart="onTxStart",m.onTxSent="onTxSent",m.onTxFinalized="onTxFinalized",m.onTxFailure="onTxFailure",m.onSignMsgStart="onSignMsgStart",m.onSignMsgFinalized="onSignMsgFinalized",m.onSignMsgFailure="onSignMsgFailure",m.onQueryStart="onQueryStart",m.onQueryFinalized="onQueryFinalized",m.onQueryFailure="onQueryFailure",m))(E||{}),W=(s=>(s.ledger="ledger",s.mobile="mobile",s.webWallet="web-wallet",s.browserExtension="browser-extension",s.xAlias="x-alias",s.webview="webview",s))(W||{}),mt=(t=>(t.mvx_cancelAction="mvx_cancelAction",t.mvx_signNativeAuthToken="mvx_signNativeAuthToken",t))(mt||{}),Pe=(e=>(e.hasWebWalletGuardianSign="hasWebWalletGuardianSign",e))(Pe||{});var P={};st(P,{clear:()=>Ae,get:()=>ft,run:()=>u,set:()=>p});var _;function p(n,e){n&&(_={..._,[n]:e})}function ft(n){if(!(!n||!_))return _[n]}function u(n,...e){!n||!_||_[n]?.(...e)}function Ae(){_=void 0}var f=n=>typeof n=="string"?n.toUpperCase():n instanceof Error?n.message:JSON.stringify(n);var Re=async n=>{if(!n.dappProvider)throw new Error("Logout failed: There is no active session!");u("onLogoutStart");try{let e=await n.dappProvider.logout();return e&&(d.clear(),u("onLogoutSuccess")),e}catch(e){let t=f(e);console.warn(`Something went wrong trying to logout the user: ${t}`),u("onLogoutFailure",t)}};var H=()=>new Date().setHours(new Date().getHours()+24),ue=n=>Date.now()>n;var B=async n=>{let e=d.get("address"),t=d.get("expires");if(!(typeof t=="number"?ue(t):!0)&&e&&n.networkProvider){let o=new I(e);try{let i=await n.networkProvider.getAccount(e),s=await n.networkProvider.getGuardianData(e);d.set("address",e),d.set("activeGuardian",s.guarded&&s.activeGuardian?.address?s.activeGuardian.address:""),d.set("nonce",i.nonce.valueOf()),d.set("balance",i.balance.toString()),o.update(i)}catch(i){let s=f(i);console.warn(`Something went wrong trying to synchronize the user account: ${s}`)}}};var je=async(n,e,t,r="/")=>{let o=await ae(),s={callbackUrl:encodeURIComponent(`${window.location.origin}${r}`),token:e};try{if(o&&!await o.login(s))throw new Error("There were problems while logging in!")}catch(g){let T=f(g);throw new Error(T)}if(!o)throw new Error("There were problems with auth provider initialization!");let c=o.getAccount();d.set("loginToken",e);let l=c?.signature;if(l&&d.set("signature",l),n.networkProvider&&l)try{let g=await o.getAddress();if(!g)throw new Error("Canceled!");d.set("address",g),d.set("loginMethod","browser-extension"),d.set("expires",H()),await B(n);let T=t.getToken(g,e,l);return d.set("accessToken",T),u("onLoginSuccess"),o}catch(g){throw new Error(`Something went wrong trying to synchronize the user account: ${g?.message}`)}};var Ee=async(n,e,t,r)=>{let o=new v(`${n}${O}`),s={callbackUrl:typeof window<"u"?encodeURIComponent(`${window.location.origin}${r||"/"}`):"/",token:e};try{return d.set("loginMethod",y[t].xAliasAddress===n?"x-alias":"web-wallet"),await o.login(s),d.set("expires",H()),d.set("loginToken",e),o}catch(c){let l=f(c);console.warn(`Something went wrong trying to login the user: ${l}`),d.set("loginMethod",""),u("onLoginFailure",l)}};var ge=async(n,e)=>{u("onTxSent",n);let r=await new J(e).awaitCompleted(n.txHash),o=r.sender,i=new I(o),s=await e.getAccount(o);i.update(s),d.set("address",i.bech32()),d.set("balance",i.balance),u("onTxFinalized",r)};var pe=n=>{let e=n.sender,t=new I(e),r=n.nonce.valueOf();t.incrementNonce(),d.set("nonce",(r+1n).toString())};var Ke=async(n,e,t,r)=>{if(w(j)===Y&&n&&e){let i=d.get("activeGuardian"),s=d.get("loginMethod"),c=w("hasWebWalletGuardianSign"),l;if("getTransactionsFromWalletUrl"in n){if(l=n.getTransactionsFromWalletUrl()?.[0],!l)return;s==="web-wallet"&&(l.data=R(l.data))}else i&&s!=="web-wallet"&&s!=="x-alias"&&c&&(l=new v(`${t}${O}`).getTransactionsFromWalletUrl()?.[0]);if(l){let g=h.plainObjectToTransaction(l);g.nonce=BigInt(r),pe(g);try{u("onTxStart",g);let T=await e.sendTransaction(g);await ge(T,e)}catch(T){let Le=`Getting transaction information failed! ${f(T)}`;throw u("onTxFailure",g,Le),new Error(Le)}finally{window.history.replaceState(null,"",window.location.pathname)}}window.history.replaceState(null,"",window.location.pathname)}};var Ve=n=>{let e=d.get("activeGuardian");return e&&(n.version=X,n.options=_e,n.guardian=e),n},Je=async(n,e)=>{let t=new v(`${e}${O}`),r=window?.location.href,o=new URL(r);o.searchParams.set("hasWebWalletGuardianSign","true"),await t.guardTransactions([n],{callbackUrl:encodeURIComponent(o.toString())})},Xe=n=>{let e=d.get("activeGuardian");return!(!d.get("address")||!e||n.isGuardedTransaction())};var Ye=()=>{let n=!w("walletProviderStatus"),e=w("status")==="signed",t=w("message"),r=w("signature");n&&e&&t&&r&&(u("onSignMsgFinalized",t,r),window.history.replaceState(null,"",window.location.pathname))};function ht(n){try{let e=atob(n),t=btoa(e),r=z(n),o=R(r),i=n===t||t.startsWith(n),s=n===o||o.startsWith(n);if(i&&s)return!0}catch{return!1}return!1}function q(n){return ht(n)?atob(n):n}var me=n=>Object.prototype.toString.call(n)==="[object String]";var Ze=n=>{if(!n||!me(n))return null;let e=n.split(".");if(e.length!==4)return null;try{let[t,r,o,i]=e,s=JSON.parse(q(i)),c=q(t);return{ttl:Number(o),extraInfo:s,origin:c,blockHash:r}}catch(t){return console.error(`Error trying to decode ${n}:`,t),null}};var et=n=>{if(!n||!me(n))return null;let e=n.split(".");if(e.length!==3)return console.error("Invalid nativeAuthToken. You may be trying to decode a loginToken. Try using decodeLoginToken method instead"),null;try{let[t,r,o]=e,i=q(t),s=q(r),c=Ze(s);if(!c)return{address:i,body:s,signature:o,blockHash:"",origin:"",ttl:0};let l={...c,address:i,body:s,signature:o};return c.extraInfo?.timestamp||delete l.extraInfo,l}catch{return null}};function tt(n,e){let t=et(n);if(t==null)return;let{signature:r,address:o,body:i}=t;r&&n&&o&&(d.set("loginToken",i),d.set("accessToken",n),d.set("signature",r),d.set("address",o),d.set("loginMethod","webview"),e.dappProvider=new U)}var nt=n=>{n.onLoginStart&&p("onLoginStart",n.onLoginStart),n.onLoginSuccess&&p("onLoginSuccess",n.onLoginSuccess),n.onLoginFailure&&p("onLoginFailure",n.onLoginFailure),n.onLogoutStart&&p("onLogoutStart",n.onLogoutStart),n.onLogoutSuccess&&p("onLogoutSuccess",n.onLogoutSuccess),n.onLogoutFailure&&p("onLogoutFailure",n.onLogoutFailure);let e=n?.externalSigningProviders?.mobile?.config;e?.onQrPending&&p("onQrPending",e.onQrPending),e?.onQrLoaded&&p("onQrLoaded",e.onQrLoaded),n.onTxStart&&p("onTxStart",n.onTxStart),n.onTxSent&&p("onTxSent",n.onTxSent),n.onTxFinalized&&p("onTxFinalized",n.onTxFinalized),n.onTxFailure&&p("onTxFailure",n.onTxFailure),n.onSignMsgStart&&p("onSignMsgStart",n.onSignMsgStart),n.onSignMsgFinalized&&p("onSignMsgFinalized",n.onSignMsgFinalized),n.onSignMsgFailure&&p("onSignMsgFailure",n.onSignMsgFailure),n.onQueryStart&&p("onQueryStart",n.onQueryStart),n.onQueryFinalized&&p("onQueryFinalized",n.onQueryFinalized),n.onQueryFailure&&p("onQueryFailure",n.onQueryFailure)};var fe=async n=>{u("onLoginStart");try{await n(()=>{u("onLoginSuccess")})}catch(e){let t=f(e);console.warn(`Something went wrong trying to login the user: ${t}`),u("onLoginFailure",t)}};var a={initOptions:void 0,dappProvider:void 0,networkProvider:void 0,mobileProvider:void 0},rt=()=>{a.initOptions=void 0,a.dappProvider=void 0,a.networkProvider=void 0,a.mobileProvider=void 0};var Qi=async n=>{let e=d.get();if(e.expires&&ue(e.expires)){d.clear(),a.dappProvider=void 0;return}a.initOptions={chainType:se,apiUrl:Qe,apiTimeout:1e4,...n},a.networkProvider=new le(a.initOptions),nt(a.initOptions);let t=a.initOptions?.externalSigningProviders?.mobile?.provider;if(t){let i={networkConfig:y,Message:x,Transaction:C,TransactionsConverter:h,ls:d,logout:Re,getNewLoginExpiresTimestamp:H,accountSync:B,EventsStore:P},s=a.initOptions?.externalSigningProviders?.mobile?.config;if(s)a.mobileProvider=new t(s,i);else throw new Error("Mobile provider config is required!")}let r=w("accessToken");r&&await fe(async i=>{tt(r,a),await B(a),i()}),(e?.address||(e.loginMethod==="web-wallet"||e.loginMethod==="x-alias")&&w("address"))&&e?.loginMethod&&(await fe(async i=>{e.loginMethod==="browser-extension"&&(a.dappProvider=await ae()),e.loginMethod==="mobile"&&a.mobileProvider&&(a.dappProvider=await a.mobileProvider?.initMobileProvider(a)),e.loginMethod==="webview"&&(a.dappProvider=new U),e.loginMethod==="web-wallet"&&a.initOptions?.chainType&&(a.dappProvider=await Se(y[a.initOptions.chainType].walletAddress,a.initOptions.apiUrl)),e.loginMethod==="x-alias"&&a.initOptions?.chainType&&(a.dappProvider=await Se(y[a.initOptions.chainType].xAliasAddress,a.initOptions.apiUrl)),await B(a),i()}),a.initOptions?.chainType&&(await Ke(a.dappProvider,a.networkProvider,y[a.initOptions.chainType][e.loginMethod==="x-alias"?"xAliasAddress":"walletAddress"],e.nonce),Ye()))},ji=async(n,e)=>{if(!Object.values(W).includes(n)){let r="Wrong login method!";throw u("onLoginFailure",r),new Error(r)}if(!a.networkProvider){let r="Login failed: Use ElvenJs.init() first!";throw u("onLoginFailure",r),new Error(r)}await fe(async()=>{let r=new $({apiUrl:a.initOptions?.apiUrl,origin:window.location.origin}),o=await r.initialize({timestamp:`${Math.floor(Date.now()/1e3)}`});if(n==="browser-extension"){let i=await je(a,o,r,e?.callbackRoute);a.dappProvider=i}if(n==="mobile"&&a.mobileProvider){let i=await a.mobileProvider?.loginWithMobile(a,o,r);a.dappProvider=i}if(n==="web-wallet"&&a.initOptions?.chainType){let i=await Ee(y[a.initOptions.chainType].walletAddress,o,a.initOptions?.chainType,e?.callbackRoute);a.dappProvider=i}if(n==="x-alias"&&a.initOptions?.chainType){let i=await Ee(y[a.initOptions.chainType].xAliasAddress,o,a.initOptions?.chainType,e?.callbackRoute);a.dappProvider=i}})},Ki=async()=>{try{let n=await Re(a);return a.dappProvider=void 0,n}catch(n){let e=f(n);console.warn("Something went wrong when logging out: ",e)}},Vi=async n=>{if(!a.dappProvider){let t="Transaction signing failed: There is no active session!";throw u("onTxFailure",n,t),new Error(t)}if(!a.networkProvider){let t="Transaction signing failed: There is no active network provider!";throw u("onTxFailure",n,t),new Error(t)}let e=Ve(n);try{u("onTxStart",n);let t=d.get();if(n.nonce=t.nonce,a.dappProvider instanceof M&&(e=await a.dappProvider.signTransaction(n)),a.mobileProvider&&a.dappProvider instanceof a.mobileProvider.WalletConnectV2Provider&&(e=await a.dappProvider.signTransaction(n)),a.dappProvider instanceof U&&(e=await a.dappProvider.signTransaction(n)),a.dappProvider instanceof v&&await a.dappProvider.signTransaction(n),t.loginMethod!=="web-wallet"&&t.loginMethod!=="x-alias"){let r=Xe(e);if(r||pe(e),r&&a.initOptions?.chainType){await Je(e,y[a.initOptions.chainType].walletAddress);return}let o=await a.networkProvider.sendTransaction(e);await ge(o,a.networkProvider)}}catch(t){let r=f(t);throw u("onTxFailure",e,`Getting transaction information failed! ${r}`),new Error(`Getting transaction information failed! ${r}`)}return e},Ji=async(n,e)=>{if(!a.dappProvider){let r="Message signing failed: There is no active session!";throw u("onSignMsgFailure",n,r),new Error(r)}if(!a.networkProvider){let r="Message signing failed: There is no active network provider!";throw u("onSignMsgFailure",n,r),new Error(r)}let t="";try{if(u("onSignMsgStart",n),a.dappProvider instanceof M){let o=await a.dappProvider.signMessage(new x({data:L(n)}));typeof o!="string"&&o?.signature&&(t=b(o.signature))}if(a.mobileProvider&&a.dappProvider instanceof a.mobileProvider.WalletConnectV2Provider){let o=await a.dappProvider.signMessage(new x({data:L(n)}));typeof o!="string"&&o?.signature&&(t=b(o.signature))}if(a.dappProvider instanceof U){let o=await a.dappProvider.signMessage(new x({data:L(n)}));typeof o!="string"&&o?.signature&&(t=b(o.signature))}if(a.dappProvider instanceof v){let o=s=>encodeURIComponent(s).replace(/[!'()*]/g,c=>`%${c.charCodeAt(0).toString(16).toUpperCase()}`),i=e?.callbackUrl||window.location.origin;await a.dappProvider.signMessage(new x({data:L(n)}),{callbackUrl:encodeURIComponent(`${i}${i.includes("?")?"&":"?"}message=${o(n)}`)})}let r=d.get();return r.loginMethod!=="web-wallet"&&r.loginMethod!=="x-alias"&&u("onSignMsgFinalized",n,t),{message:n,messageSignature:t}}catch(r){let o=f(r);throw u("onSignMsgFailure",n,o),new Error(`Message signing failed! ${o}`)}},Xi=async({address:n,func:e,args:t=[],value:r=0,caller:o})=>{if(!a.networkProvider)throw new Error("Query failed: There is no active network provider!");if(!n||!e)throw new Error("Query failed: The Query arguments are not valid! Address and func required");let i={address:n,func:e,args:t,value:r,caller:o};try{u("onQueryStart",i);let s=await a.networkProvider.queryContract(i);return u("onQueryFinalized",s),s}catch(s){let c=f(s);throw u("onQueryFinalized",i,c),new Error(`Smart contract query failed! ${c}`)}},Yi=d,Zi=()=>{rt(),Ae()};var Tt=({amount:n,decimals:e})=>{if(e<0)throw new Error("Decimal places shouldn't be negative number!");let t=n.toString().replace(/,/g,""),[r,o=""]=t.split("."),i=r+o.padEnd(e,"0");return i=i.substring(0,r.length+e),BigInt(i)},it=({amount:n,decimals:e,rounding:t=e})=>{if(e<0)throw new Error("Decimal places shouldn't be negative number!");let r=BigInt(n)<0n,o=BigInt(n).toString();r&&(o=o.slice(1)),o=o.padStart(e+1,"0");let i=o.slice(0,-e),s=o.slice(-e);if(t<e){let l=parseInt(s.charAt(t),10);if(s=s.slice(0,t),l>=5){let g=BigInt("1"+"0".repeat(e-t)),T=BigInt(n)+g;return r&&(T=-T),it({amount:T,decimals:e,rounding:t})}}let c=`${i}.${s.padEnd(t,"0")}`;return c=c.replace(/\.?0+$/,""),r&&(c=`-${c}`),c};export{I as Account,mt as DappCoreWCV2CustomMethodsEnum,E as EventStoreEvents,W as LoginMethodsEnum,C as Transaction,J as TransactionWatcher,Pe as WebWalletUrlParamsEnum,Zi as destroy,it as formatAmount,Qi as init,ji as login,Ki as logout,Tt as parseAmount,Xi as queryContract,Vi as signAndSendTransaction,Ji as signMessage,Yi as storage};
/** keccak.js https://github.com/adraffy/keccak.js @license MIT */
/** https://github.com/emn178/js-sha3/blob/master/src/sha3.js @license MIT */
