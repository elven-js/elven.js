/*!
 * Portions of this code are derived from MultiversX libraries.
 * These portions are licensed under the MIT License.
 *
 * See the MultiversX repository for details: https://github.com/multiversx
 * See the attached MIT licence for elven.js: https://github.com/elven-js/elven.js/blob/main/LICENSE
 */

var C="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Re=new Uint8Array(256);for(let n=0;n<C.length;n++)Re[C.charCodeAt(n)]=n;var et=new TextEncoder,tt=new TextDecoder,Ie=n=>/^[0-9a-fA-F]{64}$/.test(n),R=n=>et.encode(n),I=n=>tt.decode(n),x=n=>{if(!/^[0-9a-fA-F]+$/.test(n)||n.length%2!==0)throw new Error("Invalid hex string");let e=new Uint8Array(n.length/2);for(let t=0;t<e.length;t++)e[t]=parseInt(n.substr(t*2,2),16);return e},y=n=>Array.from(n).map(e=>e.toString(16).padStart(2,"0")).join(""),Ee=n=>y(R(n)),N=n=>{n=n.replace(/[^A-Za-z0-9+/=]/g,"");let e=0;n.endsWith("==")?e=2:n.endsWith("=")&&(e=1);let t=Math.floor(n.length*6/8-e),r=new Uint8Array(t),o=0,i=0,s=0;for(let a=0;a<n.length;a++){let l=n.charAt(a);if(l==="=")break;o=o<<6|Re[l.charCodeAt(0)],i+=6,i>=8&&(i-=8,r[s++]=o>>i&255)}return r},nt=n=>{let e="",t=n.length;for(let r=0;r<t;r+=3){let o=n[r],i=r+1<t?n[r+1]:0,s=r+2<t?n[r+2]:0,a=o<<16|i<<8|s,l=a>>18&63,u=a>>12&63,m=a>>6&63,Pe=a&63;e+=C.charAt(l),e+=C.charAt(u),e+=r+1<t?C.charAt(m):"=",e+=r+2<t?C.charAt(Pe):"="}return e},$=n=>I(N(n)),S=n=>{let e=typeof n=="string"?R(n):n;return nt(e)};function rt(n){let e=[],t=/([^[\]]+)|\[(.*?)\]/g,r;for(;(r=t.exec(n))!==null;)r[1]!==void 0?e.push(r[1]):r[2]!==void 0&&(r[2]===""?e.push(""):/^\d+$/.test(r[2])?e.push(Number(r[2])):e.push(r[2]));return e}function it(n,e,t){let r=n;for(let o=0;o<e.length;o++){let i=e[o];if(o===e.length-1)i===""?(Array.isArray(r)||(r=[]),r.push(t)):(typeof i=="number"&&(Array.isArray(r)||(r=[])),r[i]=t);else{let s=e[o+1];i===""?(Array.isArray(r)||(r=[]),(r.length===0||typeof r[r.length-1]!="object")&&r.push(typeof s=="number"?[]:{}),r=r[r.length-1]):typeof i=="number"?(Array.isArray(r)||(r=[]),r[i]||(r[i]=typeof s=="number"?[]:{}),r=r[i]):(r[i]||(r[i]=typeof s=="number"||s===""?[]:{}),r=r[i])}}}function ge(n,e,t){if(e!=null)if(typeof e=="object")if(Array.isArray(e))e.forEach(r=>{ge([...n,""],r,t)});else for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&ge([...n,r],e[r],t);else{let r=n.map((o,i)=>i===0?encodeURIComponent(String(o)):o===""?"[]":`[${encodeURIComponent(String(o))}]`).join("");t.push(`${r}=${encodeURIComponent(e)}`)}}function pe(n){let e=new URLSearchParams(n),t={};for(let[r,o]of e.entries()){let i=rt(r);it(t,i,o)}return t}function Le(n){let e=[];return ge([],n,e),e.join("&")}var ot=()=>typeof window<"u"&&typeof window.location<"u",H=()=>{if(ot()){let n=window.location.ancestorOrigins;return n?.[n.length-1]??"*"}return"*"},he=()=>{let n=window;return!!(n?.ReactNativeWebView||n?.webkit)};var A=class{constructor(e){this.address=new Uint8Array([]);this.nonce=0;this.balance="0";Ie(e)&&(this.address=x(e))}update(e){this.nonce=e.nonce,this.balance=e.balance}incrementNonce(){this.nonce=this.nonce+1}getNonceThenIncrement(){let e=this.nonce;return this.nonce=this.nonce+1,e}toJSON(){return{address:y(this.address),nonce:this.nonce,balance:this.balance}}bech32(){return y(this.address)}};var Oe=1e9,Ue=0,j=2,ke=2,me=64,Ce=1;var Me="sdk-js";var We="hook/login",_e="hook/logout";var De="hook/sign",Fe="hook/2fa",Ge="hook/sign-message",B="walletProviderStatus",K="transactionsSigned";var $e={SIGN_TRANSACTIONS_REQUEST:"SIGN_TRANSACTIONS_RESPONSE",GUARD_TRANSACTIONS_REQUEST:"GUARD_TRANSACTIONS_RESPONSE",SIGN_MESSAGE_REQUEST:"SIGN_MESSAGE_RESPONSE",LOGIN_REQUEST:"LOGIN_RESPONSE",LOGOUT_REQUEST:"DISCONNECT_RESPONSE",CANCEL_ACTION_REQUEST:"CANCEL_RESPONSE",FINALIZE_HANDSHAKE_REQUEST:"NONE_RESPONSE",FINALIZE_RESET_STATE_REQUEST:"RESET_STATE_RESPONSE"};var O=class{constructor(e){this.nonce=BigInt(e.nonce?.valueOf()||0n),this.value=e.value??0n,this.sender=this.addressAsBech32(e.sender),this.receiver=this.addressAsBech32(e.receiver),this.senderUsername=e.senderUsername||"",this.receiverUsername=e.receiverUsername||"",this.gasPrice=BigInt(e.gasPrice?.valueOf()||Oe),this.gasLimit=BigInt(e.gasLimit.valueOf()),this.data=e.data?.valueOf()||new Uint8Array,this.chainID=e.chainID.valueOf(),this.version=Number(e.version?.valueOf()||j),this.options=Number(e.options?.valueOf()||Ue),this.guardian=e.guardian?this.addressAsBech32(e.guardian):"",this.signature=e.signature||new Uint8Array([]),this.guardianSignature=e.guardianSignature||new Uint8Array([])}addressAsBech32(e){return e}isGuardedTransaction(){let e=this.guardian.length>0,t=this.guardianSignature.length>0;return e&&t}};var v=class extends Error{constructor(t,r){super(t);this.inner=void 0;this.inner=r}summary(){let t=[];t.push({name:this.name,message:this.message});let r=this.inner;for(;r;)t.push({name:r.name,message:r.message}),r=r.inner;return t}};var V=class extends v{constructor(){super("Async timer already running")}},J=class extends v{constructor(){super("Async timer aborted")}};var M=class extends v{constructor(){super("Expected transaction status not reached")}},q=class extends v{constructor(){super("Expected transaction events not found")}};var X=class extends v{constructor(){super("The transaction watcher requires the `isCompleted` property to be defined on the transaction object. Perhaps you've used the sdk-network-provider's `ProxyNetworkProvider.getTransaction()` and in that case you should also pass `withProcessStatus=true`.")}};var Y=class extends v{constructor(){super("Cannot sign single transaction.")}},Z=class extends v{constructor(){super("Account is not connected.")}},z=class extends Error{constructor(){super("Cannot get signed transaction(s)")}},ee=class extends Error{constructor(){super("Cannot get signed message")}};var W=class{constructor(e){this.timeoutHandle=null;this.rejectionFunc=null;this.name=e,this.correlationTag=0}start(e){if(this.timeoutHandle)throw new V;return this.correlationTag++,new Promise((t,r)=>{this.rejectionFunc=r;let o=()=>{this.rejectionFunc=null,this.stop(),t()};this.timeoutHandle=setTimeout(o,e)})}abort(){this.rejectionFunc&&(this.rejectionFunc(new J),this.rejectionFunc=null),this.stop()}stop(){this.isStopped()||this.timeoutHandle&&(clearTimeout(this.timeoutHandle),this.timeoutHandle=null)}isStopped(){return!this.timeoutHandle}};var fe=class{constructor(e){this.fetcher=e}async getTransaction(e){return await this.fetcher.getTransaction(e)}},Q=class n{static{this.DefaultPollingInterval=6e3}static{this.DefaultTimeout=n.DefaultPollingInterval*15}static{this.DefaultPatience=0}static{this.NoopOnStatusReceived=()=>{}}constructor(e,t={}){this.fetcher=new fe(e),this.pollingIntervalMilliseconds=t.pollingIntervalMilliseconds||n.DefaultPollingInterval,this.timeoutMilliseconds=t.timeoutMilliseconds||n.DefaultTimeout,this.patienceMilliseconds=t.patienceMilliseconds||n.DefaultPatience}async awaitPending(e){let t=i=>i.status.isPending(),r=async()=>{let i=this.transactionOrTxHashToTxHash(e);return await this.fetcher.getTransaction(i)},o=()=>new M;return this.awaitConditionally(t,r,o)}async awaitCompleted(e){let t=i=>{if(i.isCompleted===void 0)throw new X;return i.isCompleted},r=async()=>{let i=this.transactionOrTxHashToTxHash(e);return await this.fetcher.getTransaction(i)},o=()=>new M;return this.awaitConditionally(t,r,o)}async awaitAllEvents(e,t){let r=s=>{let a=this.getAllTransactionEvents(s).map(u=>u.identifier);return t.every(u=>a.includes(u))},o=async()=>{let s=this.transactionOrTxHashToTxHash(e);return await this.fetcher.getTransaction(s)},i=()=>new q;return this.awaitConditionally(r,o,i)}async awaitAnyEvent(e,t){let r=s=>{let a=this.getAllTransactionEvents(s).map(u=>u.identifier);return t.find(u=>a.includes(u))!=null},o=async()=>{let s=this.transactionOrTxHashToTxHash(e);return await this.fetcher.getTransaction(s)},i=()=>new q;return this.awaitConditionally(r,o,i)}async awaitOnCondition(e,t){let r=async()=>{let i=this.transactionOrTxHashToTxHash(e);return await this.fetcher.getTransaction(i)},o=()=>new M;return this.awaitConditionally(t,r,o)}transactionOrTxHashToTxHash(e){let t=typeof e=="string"?e:e.getHash().hex();if(t.length!==me)throw new v(`Invalid transaction hash length. The length of a hex encoded hash should be ${me}.`);return t}async awaitConditionally(e,t,r){let o=new W("watcher:periodic"),i=new W("watcher:patience"),s=new W("watcher:timeout"),a=!1,l,u=!1;for(s.start(this.timeoutMilliseconds).finally(()=>{s.stop(),a=!0});!a&&(await o.start(this.pollingIntervalMilliseconds),l=await t(),u=e(l),!(u||a)););if(u&&await i.start(this.patienceMilliseconds),s.isStopped()||s.stop(),!l||!u)throw r();return l}getAllTransactionEvents(e){let t=[...e.logs.events];for(let r of e.contractResults.items)t.push(...r.logs.events);return t}};var b=class{constructor(e){this.data=e.data,this.signature=e.signature,this.address=e.address,this.version=e.version||Ce,this.signer=e.signer||Me}};var h=class{static transactionToPlainObject(e){return{nonce:Number(e.nonce),value:e.value.toString(),receiver:e.receiver,sender:e.sender,senderUsername:e.senderUsername?S(e.senderUsername):void 0,receiverUsername:e.receiverUsername?S(e.receiverUsername):void 0,gasPrice:Number(e.gasPrice),gasLimit:Number(e.gasLimit),data:e.data&&e.data.length?S(e.data):void 0,chainID:e.chainID,version:e.version,options:e.options==0?void 0:e.options,guardian:e.guardian?e.guardian:void 0,signature:e.signature&&e.signature.length?y(e.signature):void 0,guardianSignature:e.guardianSignature&&e.guardianSignature.length?y(e.guardianSignature):void 0}}static plainObjectToTransaction(e){return new O({nonce:BigInt(e.nonce),value:BigInt(e.value||""),receiver:e.receiver,receiverUsername:$(e.receiverUsername||""),sender:e.sender,senderUsername:$(e.senderUsername||""),guardian:e.guardian,gasPrice:BigInt(e.gasPrice),gasLimit:BigInt(e.gasLimit),data:e.data?N(e.data):void 0,chainID:e.chainID,version:Number(e.version),options:Number(e.options),signature:e.signature?x(e.signature):void 0,guardianSignature:e.guardianSignature?x(e.guardianSignature):void 0})}};var U=class n{constructor(){this.account={address:""};this.initialized=!1;if(n._instance)throw new Error("Error: Instantiation failed: Use ExtensionProvider.getInstance() instead of new.");n._instance=this}static{this._instance=new n}static getInstance(){return n._instance}setAddress(e){return this.account.address=e,n._instance}async init(){return window&&window.elrondWallet&&(this.initialized=!0),this.initialized}async login(e={}){if(!this.initialized)throw new Error("Extension provider is not initialised, call init() first");let{token:t}=e,r=t||"";return await this.startBgrMsgChannel("connect",r),this.account}async logout(){if(!this.initialized)throw new Error("Extension provider is not initialised, call init() first");try{await this.startBgrMsgChannel("logout",this.account.address),this.disconnect()}catch(e){console.warn("Extension origin url is already cleared!",e)}return!0}disconnect(){this.account={address:""}}async getAddress(){if(!this.initialized)throw new Error("Extension provider is not initialised, call init() first");return this.account?this.account.address:""}isInitialized(){return this.initialized}isConnected(){return!!this.account.address}getAccount(){return this.account}setAccount(e){this.account=e}async signTransaction(e){this.ensureConnected();let t=await this.signTransactions([e]);if(t.length!=1)throw new Y;return t[0]}ensureConnected(){if(!this.account.address)throw new Z}async signTransactions(e){this.ensureConnected();let t=await this.startBgrMsgChannel("signTransactions",{from:this.account.address,transactions:e.map(r=>h.transactionToPlainObject(r))});try{return t.map(o=>h.plainObjectToTransaction(o))}catch(r){throw new Error(`Transaction canceled: ${r.message}.`)}}async signMessage(e){this.ensureConnected();let t={account:this.account.address,message:I(e.data)},o=(await this.startBgrMsgChannel("signMessage",t)).signature,i=x(o);return new b({data:e.data,address:e.address??this.account.address,signer:"extension",version:e.version,signature:i})}cancelAction(){return this.startBgrMsgChannel("cancelAction",{})}startBgrMsgChannel(e,t){return new Promise(r=>{window.postMessage({target:"erdw-inpage",type:e,data:t},window.origin);let o=i=>{i.isTrusted&&i.data.target==="erdw-contentScript"&&(i.data.type==="connectResponse"?(i.data.data&&i.data.data.address&&(this.account=i.data.data),window.removeEventListener("message",o),r(i.data.data)):(window.removeEventListener("message",o),r(i.data.data)))};window.addEventListener("message",o,!1)})}};var te="elvenjs_state",He="https://devnet-api.multiversx.com";var E="/dapp/init",ne="devnet";var T={devnet:{id:"devnet",shortId:"D",name:"Devnet",egldLabel:"xEGLD",egldDenomination:"18",decimals:"4",gasPerDataByte:"1500",walletAddress:"https://devnet-wallet.multiversx.com",xAliasAddress:"https://devnet.xalias.com",apiAddress:"https://devnet-api.multiversx.com",explorerAddress:"https://devnet-explorer.multiversx.com",apiTimeout:1e4},testnet:{id:"testnet",shortId:"T",name:"Testnet",egldLabel:"xEGLD",egldDenomination:"18",decimals:"4",gasPerDataByte:"1500",walletAddress:"https://testnet-wallet.multiversx.com",xAliasAddress:"https://testnet.xalias.com",apiAddress:"https://testnet-api.multiversx.com",explorerAddress:"https://testnet-explorer.multiversx.com",apiTimeout:1e4},mainnet:{id:"mainnet",shortId:"1",name:"Mainnet",egldLabel:"EGLD",egldDenomination:"18",decimals:"4",gasPerDataByte:"1500",walletAddress:"https://wallet.multiversx.com",xAliasAddress:"https://xalias.com",apiAddress:"https://api.multiversx.com",explorerAddress:"https://explorer.multiversx.com",apiTimeout:1e4}};var d={get(n){let e=localStorage.getItem(te);if(!e)return{};let t=JSON.parse(e);return n?t[n]:t},set(n,e){let t=this.get();t[n]=e,localStorage.setItem(te,JSON.stringify(t))},clear(){localStorage.removeItem(te)}};var re=async()=>{let n=U.getInstance();try{let e=await n.init(),t=d.get();if(t?.address&&n.setAddress(t.address),!e){console.warn("Something went wrong when trying to initialize the ExtensionProvider..");return}return n}catch{console.warn("Can't initialize the Dapp Provider!")}};var Te=class{constructor(e){this.nonce=0;this.value="";this.receiver="";this.sender="";this.gasPrice=0;this.gasLimit=0;this.data="";this.chainID="";this.version=0;this.signature="";Object.assign(this,e)}},w=class n{constructor(e){this.walletUrl=e}async login(e){let t=this.buildWalletUrl({endpoint:We,callbackUrl:e?.callbackUrl,params:{token:e?.token}});return await this.redirect(t,e?.redirectDelayMilliseconds),t}async redirect(e,t){t?await this.redirectLater(e,t):this.redirectImmediately(e)}redirectImmediately(e){window.location.href=e}async redirectLater(e,t){await new Promise(r=>{setTimeout(()=>{window.location.href=e,r(!0)},t)})}async logout(e){let t=this.buildWalletUrl({endpoint:_e,callbackUrl:e?.callbackUrl});return await this.redirect(t,e?.redirectDelayMilliseconds),!0}async signMessage(e,t){let r=this.buildWalletUrl({endpoint:Ge,callbackUrl:t?.callbackUrl,params:{message:I(e.data)}});return await this.redirect(r),r}getMessageSignatureFromWalletUrl(){let e=window.location.search.slice(1);console.info("getMessageSignatureFromWalletUrl(), url:",e);let t=pe(e);if((t.status?.toString()||"")!=="signed")throw new ee;return t.signature?.toString()||""}async guardTransactions(e,t){this.redirectTransactionsToEndpoint(Fe,e,t)}async signTransactions(e,t){this.redirectTransactionsToEndpoint(De,e,t)}async signTransaction(e,t){await this.signTransactions([e],t)}getTransactionsFromWalletUrl(e=window.location.search){let t=pe(e.slice(1));return n.isTxSignReturnSuccess(t)?this.getTxSignReturnValue(t):[]}static isTxSignReturnSuccess(e){return Object.prototype.hasOwnProperty.call(e,B)&&e[B]===K}getTxSignReturnValue(e){console.info("getTxSignReturnValue(), urlParams:",e);let t=["nonce","value","receiver","sender","gasPrice","gasLimit","chainID","version","signature"];for(let i of t)if(!e[i]||!Array.isArray(e[i]))throw new z;let r=e.nonce.length;for(let i of t)if(e[i].length!==r)throw new z;let o=[];for(let i=0;i<r;i++){let s=new Te({nonce:parseInt(e.nonce[i]),value:e.value[i],receiver:e.receiver[i],sender:e.sender[i],gasPrice:parseInt(e.gasPrice[i]),gasLimit:parseInt(e.gasLimit[i]),data:e.data&&e.data[i]?e.data[i]:"",chainID:e.chainID[i],version:parseInt(e.version[i]),...e.guardian&&e.guardian[i]?{guardian:e.guardian[i]}:{},...e.guardianSignature&&e.guardianSignature[i]?{guardianSignature:e.guardianSignature[i]}:{},...e.options&&e.options[i]?{options:parseInt(e.options[i])}:{},...e.senderUsername&&e.senderUsername[i]?{senderUsername:e.senderUsername[i]}:{},...e.receiverUsername&&e.receiverUsername[i]?{receiverUsername:e.receiverUsername[i]}:{},signature:e.signature[i]});o.push(s)}return o}static prepareWalletTransaction(e){let t=h.transactionToPlainObject(e);return t.data?t.data=I(N(t.data)):t.data="",t}buildWalletUrl(e){let t=e?.callbackUrl||window.location.href,r=Le(e.params||{}),o=r?`${r}&callbackUrl=${t}`:`callbackUrl=${t}`,i=`${this.baseWalletUrl()}/${e.endpoint}?${o}`;return console.info(`Redirecting to Wallet URL: ${decodeURI(i)}`),i}baseWalletUrl(){let e=this.walletUrl.split("/"),t=e[0],r=e[2];return t+"//"+r}redirectTransactionsToEndpoint(e,t,r){let o={};t.map(s=>{let a=n.prepareWalletTransaction(s);for(let l in a)Object.prototype.hasOwnProperty.call(a,l)&&!Object.prototype.hasOwnProperty.call(o,l)&&(o[l]=[]),o[l].push(a[l])});let i=this.buildWalletUrl({endpoint:e,callbackUrl:r?.callbackUrl,params:o});window.location.href=i}};var we=class{constructor(){this.origin=typeof window<"u"&&typeof window.location<"u"?window.location.hostname:"";this.apiUrl="https://api.multiversx.com";this.expirySeconds=60*60*2}},_=class{constructor(e){this.config=Object.assign(new we,e)}getToken(e,t,r){let o=this.encodeValue(e),i=this.encodeValue(t);return`${o}.${i}.${r}`}async initialize(e={}){let t=await this.getCurrentBlockHash(),r=this.encodeValue(JSON.stringify(e));return`${this.encodeValue(this.config.origin)}.${t}.${this.config.expirySeconds}.${r}`}async getCurrentBlockHash(){return await this.getCurrentBlockHashWithApi()}async getCurrentBlockHashWithApi(){let e=`${this.config.apiUrl}/blocks/latest?ttl=${this.config.expirySeconds}&fields=hash`,t=await this.get(e);return t.hash!==void 0?t.hash:this.getCurrentBlockHashWithApiFallback()}async getCurrentBlockHashWithApiFallback(){let e=`${this.config.apiUrl}/blocks?size=1&fields=hash`;return this.config.blockHashShard!==void 0&&(e+=`&shard=${this.config.blockHashShard}`),(await this.get(e)).hash}encodeValue(e){return this.escape(S(e))}escape(e){return e.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}async get(e){try{let t=await fetch(e,{method:"GET",headers:this.config.extraRequestHeaders});if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);return await t.json()}catch(t){throw console.error("There was a problem with the fetch operation:",t),t}}};var ie=(n,e)=>t=>{let r=t.data;try{r=he()&&typeof r=="string"?JSON.parse(r):r}catch{console.error("error parsing eventData",r)}let{type:o,payload:i}=r;!he()&&t.origin!=H()||!(n===o||o==="CANCEL_RESPONSE")||(typeof window<"u"&&window.removeEventListener?.("message",ie(n,e)),e({type:o,payload:i}))};var L=class n{constructor(e){this.initialized=!1;this.account={address:""};this.resetState=e=>{typeof window<"u"&&window.addEventListener("message",ie("RESET_STATE_RESPONSE",t=>{t.type==="RESET_STATE_RESPONSE"&&(e?.(),setTimeout(()=>{this.finalizeResetState()},500))}))};this.init=async()=>(await this.sendPostMessage({type:"FINALIZE_HANDSHAKE_REQUEST",payload:void 0}),this.initialized=!0,this.initialized);this.login=async()=>{if(!this.initialized)throw new Error("Provider not initialized");let e=await this.sendPostMessage({type:"LOGIN_REQUEST",payload:void 0});return e.type=="CANCEL_RESPONSE"?(console.warn("Cancelled the login action"),await this.cancelAction(),null):e.payload.data?(this.account=e.payload.data,this.account):(console.error("Error logging in",e.payload.error??"No data received"),null)};this.logout=async()=>{let e=await this.sendPostMessage({type:"LOGOUT_REQUEST",payload:void 0});return this.initialized=!1,this.disconnect(),!!e.payload.data};this.relogin=async()=>{let e=await this.sendPostMessage({type:"LOGIN_REQUEST",payload:void 0});if(e.type=="CANCEL_RESPONSE")return console.warn("Cancelled the re-login action"),await this.cancelAction(),null;if(!e.payload.data)return console.error("Re-login Error",e.payload.error??"No data received"),null;let{data:t,error:r}=e.payload;if(r||!t)throw new Error("Unable to re-login");let{accessToken:o}=t;return o?(this.account=t,o):(console.error("Unable to re-login. Missing accessToken."),null)};this.signTransactions=async e=>{let t=await this.sendPostMessage({type:"SIGN_TRANSACTIONS_REQUEST",payload:e.map(i=>h.transactionToPlainObject(i))}),{data:r,error:o}=t.payload;if(o||!r)throw new Error("Unable to sign transactions");if(t.type=="CANCEL_RESPONSE")throw this.cancelAction(),new Error("Cancelled the transactions signing action");return r.map(i=>h.plainObjectToTransaction(i))};this.signTransaction=async e=>(await this.signTransactions([e]))[0];this.signMessage=async e=>{let t=await this.sendPostMessage({type:"SIGN_MESSAGE_REQUEST",payload:{message:I(e.data)}}),{data:r,error:o}=t.payload;return o||!r?(console.error("Unable to sign message"),null):t.type=="CANCEL_RESPONSE"?(console.warn("Cancelled the message signing action"),this.cancelAction(),null):r.status!=="signed"?(console.error("Could not sign message"),null):new b({data:e.data,address:e.address??this.account.address,signer:"webview",version:e.version,signature:x(r.signature||"")})};this.cancelAction=async()=>this.sendPostMessage({type:"CANCEL_ACTION_REQUEST",payload:void 0});this.finalizeResetState=async()=>this.sendPostMessage({type:"FINALIZE_RESET_STATE_REQUEST",payload:void 0});this.sendPostMessage=async e=>{let t=window;return t&&(t.ReactNativeWebView?t.ReactNativeWebView.postMessage(JSON.stringify(e)):t.webkit?t.webkit.messageHandlers?.jsHandler?.postMessage(JSON.stringify(e),H()):t.parent&&t.parent.postMessage(e,H())),await this.waitingForResponse($e[e.type])};this.waitingForResponse=async e=>await new Promise(t=>{typeof window<"u"&&window.addEventListener?.("message",ie(e,t))});e?.resetStateCallback&&this.resetState(e.resetStateCallback)}static getInstance(e){return n._instance||(n._instance=new n(e)),n._instance}disconnect(){this.account={address:""}}isInitialized(){return this.initialized}isConnected(){return!!this.account.address}getAccount(){return this.account}setAccount(e){this.account=e}};var f=n=>{if(typeof window<"u"){let e=new URL(window.location.href);return new URLSearchParams(e.search).get(n)}};var ye=async(n,e)=>{let t=f("signature"),r=f("address"),o=d.get("address"),i=d.get("loginToken");if(t&&d.set("signature",t),r||o){r&&(d.set("address",r),window.history.replaceState(null,"",window.location.pathname));let s=new w(`${n}${E}`);if(t&&e&&r){let l=new _({apiUrl:e,origin:window.location.origin}).getToken(r,i,t);d.set("accessToken",l)}return s}};var oe=class n{constructor(e){this.status=(e||"").toLowerCase()}static createUnknown(){return new n("unknown")}isPending(){return this.status=="received"||this.status=="pending"}isExecuted(){return this.isSuccessful()||this.isFailed()||this.isInvalid()}isSuccessful(){return this.status=="executed"||this.status=="success"||this.status=="successful"}isFailed(){return this.status=="fail"||this.status=="failed"||this.status=="unsuccessful"||this.isInvalid()}isInvalid(){return this.status=="invalid"}toString(){return this.status}valueOf(){return this.status}equals(e){return e?this.status==e.status:!1}};var se=class{constructor({apiUrl:e,chainType:t,apiTimeout:r}){this.chainType=t||ne,this.apiUrl=e||T[this.chainType]?.apiAddress,this.apiTimeout=r||T[this.chainType]?.apiTimeout}async apiGet(e,t){if(typeof fetch<"u"){let r=new AbortController,o=setTimeout(()=>r.abort(),this.apiTimeout),i={method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"},signal:r.signal};try{let s=await fetch(this.apiUrl+"/"+e,Object.assign(i,t||{})),a=await s.json();if(!s.ok){let l=a?.error||s.status;return clearTimeout(o),Promise.reject(l)}return clearTimeout(o),a}catch(s){this.handleApiError(s,e)}}}async apiPost(e,t,r){if(typeof fetch<"u"){let o=new AbortController,i=setTimeout(()=>o.abort(),this.apiTimeout),s={method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(t||{}),signal:o.signal};try{let a=await fetch(this.apiUrl+"/"+e,Object.assign(s,r||{})),l=await a.json();if(!a.ok){let u=l?.error||a.status;return clearTimeout(i),Promise.reject(u)}return clearTimeout(i),l}catch(a){this.handleApiError(a,e)}}}handleApiError(e,t){if(!e.response)throw new Error(`Request error on url [${t}]: [${e.toString()}]`);let r=e.response.data,o=r.error||r.message||JSON.stringify(r);throw new Error(o)}async sendTransaction(e){let t=h.transactionToPlainObject(e);return await this.apiPost("transactions",t)}async getAccount(e){let t=await this.apiGet(`accounts/${e}`);return{address:t?.address||"",nonce:Number(t?.nonce||0),balance:t?.balance,code:t?.code||"",userName:t?.username||""}}async getGuardianData(e){let t=await this.apiGet(`address/${e}/guardian-data`);return{guarded:t?.data?.guardianData?.guarded||!1,activeGuardian:t?.data?.guardianData?.activeGuardian,pendingGuardian:t?.data?.guardianData?.pendingGuardian}}async getTransaction(e){let t=await this.apiGet(`transactions/${e}`),r=new oe(t.status);return{hash:e,type:t.type||"",nonce:t.nonce||0,round:t.round,epoch:t.epoch||0,value:(t.value||0).toString(),sender:t.sender,receiver:t.receiver,gasPrice:t.gasPrice||0,gasLimit:t.gasLimit||0,data:N(t.data||""),status:r,timestamp:t.timestamp||0,blockNonce:t.blockNonce||0,hyperblockNonce:t.hyperblockNonce||0,hyperblockHash:t.hyperblockHash||"",receipt:t.receipt,logs:t.logs,contractResults:t.results||[],isCompleted:!r.isPending()}}async queryContract({address:e,func:t,args:r,value:o,caller:i}){try{let s={scAddress:e,caller:i,funcName:t,value:o,args:()=>r?.map(l=>Ee(l))},a=await this.apiPost("query",s);return{returnData:a.returnData,returnCode:a.returnCode,returnMessage:a.returnMessage}}catch(s){this.handleApiError(s,"query")}}};var P=(g=>(g.onLoginStart="onLoginStart",g.onLoginSuccess="onLoginSuccess",g.onLoginFailure="onLoginFailure",g.onLogoutStart="onLogoutStart",g.onLogoutSuccess="onLogoutSuccess",g.onLogoutFailure="onLogoutFailure",g.onQrPending="onQrPending",g.onQrLoaded="onQrLoaded",g.onTxStart="onTxStart",g.onTxSent="onTxSent",g.onTxFinalized="onTxFinalized",g.onTxFailure="onTxFailure",g.onSignMsgStart="onSignMsgStart",g.onSignMsgFinalized="onSignMsgFinalized",g.onSignMsgFailure="onSignMsgFailure",g.onQueryStart="onQueryStart",g.onQueryFinalized="onQueryFinalized",g.onQueryFailure="onQueryFailure",g))(P||{}),k=(s=>(s.ledger="ledger",s.mobile="mobile",s.webWallet="web-wallet",s.browserExtension="browser-extension",s.xAlias="x-alias",s.webview="webview",s))(k||{}),at=(t=>(t.mvx_cancelAction="mvx_cancelAction",t.mvx_signNativeAuthToken="mvx_signNativeAuthToken",t))(at||{}),be=(e=>(e.hasWebWalletGuardianSign="hasWebWalletGuardianSign",e))(be||{});var c=class{static set(e,t){if(!e)return;let r={...this.events,[e]:t};this.events=r}static get(e){if(!(!e||!this.events))return this.events[e]}static run(e,...t){!e||!this.events||this.events[e]?.(...t)}static clear(){this.events=void 0}};var p=n=>typeof n=="string"?n.toUpperCase():n instanceof Error?n.message:JSON.stringify(n);var ve=async n=>{if(!n.dappProvider)throw new Error("Logout failed: There is no active session!");c.run("onLogoutStart");try{let e=await n.dappProvider.logout();return e&&(d.clear(),c.run("onLogoutSuccess")),e}catch(e){let t=p(e);console.warn(`Something went wrong trying to logout the user: ${t}`),c.run("onLogoutFailure",t)}};var D=()=>new Date().setHours(new Date().getHours()+24),ae=n=>Date.now()>n;var F=async n=>{let e=d.get("address"),t=d.get("expires");if(!(typeof t=="number"?ae(t):!0)&&e&&n.networkProvider){let o=new A(e);try{let i=await n.networkProvider.getAccount(e),s=await n.networkProvider.getGuardianData(e);d.set("address",e),d.set("activeGuardian",s.guarded&&s.activeGuardian?.address?s.activeGuardian.address:""),d.set("nonce",i.nonce.valueOf()),d.set("balance",i.balance.toString()),o.update(i)}catch(i){let s=p(i);console.warn(`Something went wrong trying to synchronize the user account: ${s}`)}}};var Be=async(n,e,t,r="/")=>{let o=await re(),s={callbackUrl:encodeURIComponent(`${window.location.origin}${r}`),token:e};try{if(o&&!await o.login(s))throw new Error("There were problems while logging in!")}catch(u){let m=p(u);throw new Error(m)}if(!o)throw new Error("There were problems with auth provider initialization!");let a=o.getAccount();d.set("loginToken",e);let l=a?.signature;if(l&&d.set("signature",l),n.networkProvider&&l)try{let u=await o.getAddress();if(!u)throw new Error("Canceled!");d.set("address",u),d.set("loginMethod","browser-extension"),d.set("expires",D()),await F(n);let m=t.getToken(u,e,l);return d.set("accessToken",m),c.run("onLoginSuccess"),o}catch(u){throw new Error(`Something went wrong trying to synchronize the user account: ${u?.message}`)}};var xe=async(n,e,t,r)=>{let o=new w(`${n}${E}`),s={callbackUrl:typeof window<"u"?encodeURIComponent(`${window.location.origin}${r||"/"}`):"/",token:e};try{return d.set("loginMethod",T[t].xAliasAddress===n?"x-alias":"web-wallet"),await o.login(s),d.set("expires",D()),d.set("loginToken",e),o}catch(a){let l=p(a);console.warn(`Something went wrong trying to login the user: ${l}`),d.set("loginMethod",""),c.run("onLoginFailure",l)}};var ce=async(n,e)=>{c.run("onTxSent",n);let r=await new Q(e).awaitCompleted(n.txHash),o=r.sender,i=new A(o),s=await e.getAccount(o);i.update(s),d.set("address",i.bech32()),d.set("balance",i.balance),c.run("onTxFinalized",r)};var de=n=>{let e=n.sender,t=new A(e),r=n.nonce.valueOf();t.incrementNonce(),d.set("nonce",(r+1n).toString())};var qe=async(n,e,t,r)=>{if(f(B)===K&&n&&e){let i=d.get("activeGuardian"),s=d.get("loginMethod"),a=f("hasWebWalletGuardianSign"),l;if("getTransactionsFromWalletUrl"in n){if(l=n.getTransactionsFromWalletUrl()?.[0],!l)return;s==="web-wallet"&&(l.data=S(l.data))}else i&&s!=="web-wallet"&&s!=="x-alias"&&a&&(l=new w(`${t}${E}`).getTransactionsFromWalletUrl()?.[0]);if(l){let u=h.plainObjectToTransaction(l);u.nonce=BigInt(r),de(u);try{c.run("onTxStart",u);let m=await e.sendTransaction(u);await ce(m,e)}catch(m){let Ae=`Getting transaction information failed! ${p(m)}`;throw c.run("onTxFailure",u,Ae),new Error(Ae)}finally{window.history.replaceState(null,"",window.location.pathname)}}window.history.replaceState(null,"",window.location.pathname)}};var ze=n=>{let e=d.get("activeGuardian");return e&&(n.version=j,n.options=ke,n.guardian=e),n},Qe=async(n,e)=>{let t=new w(`${e}${E}`),r=window?.location.href,o=new URL(r);o.searchParams.set("hasWebWalletGuardianSign","true"),await t.guardTransactions([n],{callbackUrl:encodeURIComponent(o.toString())})},je=n=>{let e=d.get("activeGuardian");return!(!d.get("address")||!e||n.isGuardedTransaction())};var Ke=()=>{let n=!f("walletProviderStatus"),e=f("status")==="signed",t=f("message"),r=f("signature");n&&e&&t&&r&&(c.run("onSignMsgFinalized",t,r),window.history.replaceState(null,"",window.location.pathname))};function ct(n){try{let e=atob(n),t=btoa(e),r=$(n),o=S(r),i=n===t||t.startsWith(n),s=n===o||o.startsWith(n);if(i&&s)return!0}catch{return!1}return!1}function G(n){return ct(n)?atob(n):n}var le=n=>Object.prototype.toString.call(n)==="[object String]";var Ve=n=>{if(!n||!le(n))return null;let e=n.split(".");if(e.length!==4)return null;try{let[t,r,o,i]=e,s=JSON.parse(G(i)),a=G(t);return{ttl:Number(o),extraInfo:s,origin:a,blockHash:r}}catch(t){return console.error(`Error trying to decode ${n}:`,t),null}};var Je=n=>{if(!n||!le(n))return null;let e=n.split(".");if(e.length!==3)return console.error("Invalid nativeAuthToken. You may be trying to decode a loginToken. Try using decodeLoginToken method instead"),null;try{let[t,r,o]=e,i=G(t),s=G(r),a=Ve(s);if(!a)return{address:i,body:s,signature:o,blockHash:"",origin:"",ttl:0};let l={...a,address:i,body:s,signature:o};return a.extraInfo?.timestamp||delete l.extraInfo,l}catch{return null}};function Xe(n,e){let t=Je(n);if(t==null)return;let{signature:r,address:o,body:i}=t;r&&n&&o&&(d.set("loginToken",i),d.set("accessToken",n),d.set("signature",r),d.set("address",o),d.set("loginMethod","webview"),e.dappProvider=new L)}var Ye=n=>{n.onLoginStart&&c.set("onLoginStart",n.onLoginStart),n.onLoginSuccess&&c.set("onLoginSuccess",n.onLoginSuccess),n.onLoginFailure&&c.set("onLoginFailure",n.onLoginFailure),n.onLogoutStart&&c.set("onLogoutStart",n.onLogoutStart),n.onLogoutSuccess&&c.set("onLogoutSuccess",n.onLogoutSuccess),n.onLogoutFailure&&c.set("onLogoutFailure",n.onLogoutFailure);let e=n?.externalSigningProviders?.mobile?.config;e?.onQrPending&&c.set("onQrPending",e.onQrPending),e?.onQrLoaded&&c.set("onQrLoaded",e.onQrLoaded),n.onTxStart&&c.set("onTxStart",n.onTxStart),n.onTxSent&&c.set("onTxSent",n.onTxSent),n.onTxFinalized&&c.set("onTxFinalized",n.onTxFinalized),n.onTxFailure&&c.set("onTxFailure",n.onTxFailure),n.onSignMsgStart&&c.set("onSignMsgStart",n.onSignMsgStart),n.onSignMsgFinalized&&c.set("onSignMsgFinalized",n.onSignMsgFinalized),n.onSignMsgFailure&&c.set("onSignMsgFailure",n.onSignMsgFailure),n.onQueryStart&&c.set("onQueryStart",n.onQueryStart),n.onQueryFinalized&&c.set("onQueryFinalized",n.onQueryFinalized),n.onQueryFailure&&c.set("onQueryFailure",n.onQueryFailure)};var ue=async n=>{c.run("onLoginStart");try{await n(()=>{c.run("onLoginSuccess")})}catch(e){let t=p(e);console.warn(`Something went wrong trying to login the user: ${t}`),c.run("onLoginFailure",t)}};var Se=class{static async init(e){let t=d.get();if(t.expires&&ae(t.expires)){d.clear(),this.dappProvider=void 0;return}this.initOptions={chainType:ne,apiUrl:He,apiTimeout:1e4,...e},this.networkProvider=new se(this.initOptions),Ye(this.initOptions);let r=this.initOptions?.externalSigningProviders?.mobile?.provider;if(r){let s={networkConfig:T,Message:b,Transaction:O,TransactionsConverter:h,ls:d,logout:ve,getNewLoginExpiresTimestamp:D,accountSync:F,EventsStore:c},a=this.initOptions?.externalSigningProviders?.mobile?.config;if(a)this.mobileProvider=new r(a,s);else throw new Error("Mobile provider config is required!")}let o=f("accessToken");o&&await ue(async s=>{Xe(o,this),await F(this),s()}),(t?.address||(t.loginMethod==="web-wallet"||t.loginMethod==="x-alias")&&f("address"))&&t?.loginMethod&&(await ue(async s=>{t.loginMethod==="browser-extension"&&(this.dappProvider=await re()),t.loginMethod==="mobile"&&this.mobileProvider&&(this.dappProvider=await this.mobileProvider?.initMobileProvider(this)),t.loginMethod==="webview"&&(this.dappProvider=new L),t.loginMethod==="web-wallet"&&this.initOptions?.chainType&&(this.dappProvider=await ye(T[this.initOptions.chainType].walletAddress,this.initOptions.apiUrl)),t.loginMethod==="x-alias"&&this.initOptions?.chainType&&(this.dappProvider=await ye(T[this.initOptions.chainType].xAliasAddress,this.initOptions.apiUrl)),await F(this),s()}),this.initOptions?.chainType&&(await qe(this.dappProvider,this.networkProvider,T[this.initOptions.chainType][t.loginMethod==="x-alias"?"xAliasAddress":"walletAddress"],t.nonce),Ke()))}static async login(e,t){if(!Object.values(k).includes(e)){let o="Wrong login method!";throw c.run("onLoginFailure",o),new Error(o)}if(!this.networkProvider){let o="Login failed: Use ElvenJs.init() first!";throw c.run("onLoginFailure",o),new Error(o)}await ue(async()=>{let o=new _({apiUrl:this.initOptions?.apiUrl,origin:window.location.origin}),i=await o.initialize({timestamp:`${Math.floor(Date.now()/1e3)}`});if(e==="browser-extension"){let s=await Be(this,i,o,t?.callbackRoute);this.dappProvider=s}if(e==="mobile"&&this.mobileProvider){let s=await this.mobileProvider?.loginWithMobile(this,i,o);this.dappProvider=s}if(e==="web-wallet"&&this.initOptions?.chainType){let s=await xe(T[this.initOptions.chainType].walletAddress,i,this.initOptions?.chainType,t?.callbackRoute);this.dappProvider=s}if(e==="x-alias"&&this.initOptions?.chainType){let s=await xe(T[this.initOptions.chainType].xAliasAddress,i,this.initOptions?.chainType,t?.callbackRoute);this.dappProvider=s}})}static async logout(){try{let e=await ve(this);return this.dappProvider=void 0,e}catch(e){let t=p(e);console.warn("Something went wrong when logging out: ",t)}}static async signAndSendTransaction(e){if(!this.dappProvider){let r="Transaction signing failed: There is no active session!";throw c.run("onTxFailure",e,r),new Error(r)}if(!this.networkProvider){let r="Transaction signing failed: There is no active network provider!";throw c.run("onTxFailure",e,r),new Error(r)}let t=ze(e);try{c.run("onTxStart",e);let r=d.get();if(e.nonce=r.nonce,this.dappProvider instanceof U&&(t=await this.dappProvider.signTransaction(e)),this.mobileProvider&&this.dappProvider instanceof this.mobileProvider.WalletConnectV2Provider&&(t=await this.dappProvider.signTransaction(e)),this.dappProvider instanceof L&&(t=await this.dappProvider.signTransaction(e)),this.dappProvider instanceof w&&await this.dappProvider.signTransaction(e),r.loginMethod!=="web-wallet"&&r.loginMethod!=="x-alias"){let o=je(t);if(o||de(t),o&&this.initOptions?.chainType){await Qe(t,T[this.initOptions.chainType].walletAddress);return}let i=await this.networkProvider.sendTransaction(t);await ce(i,this.networkProvider)}}catch(r){let o=p(r);throw c.run("onTxFailure",t,`Getting transaction information failed! ${o}`),new Error(`Getting transaction information failed! ${o}`)}return t}static async signMessage(e,t){if(!this.dappProvider){let o="Message signing failed: There is no active session!";throw c.run("onSignMsgFailure",e,o),new Error(o)}if(!this.networkProvider){let o="Message signing failed: There is no active network provider!";throw c.run("onSignMsgFailure",e,o),new Error(o)}let r="";try{if(c.run("onSignMsgStart",e),this.dappProvider instanceof U){let i=await this.dappProvider.signMessage(new b({data:R(e)}));typeof i!="string"&&i?.signature&&(r=y(i.signature))}if(this.mobileProvider&&this.dappProvider instanceof this.mobileProvider.WalletConnectV2Provider){let i=await this.dappProvider.signMessage(new b({data:R(e)}));typeof i!="string"&&i?.signature&&(r=y(i.signature))}if(this.dappProvider instanceof L){let i=await this.dappProvider.signMessage(new b({data:R(e)}));typeof i!="string"&&i?.signature&&(r=y(i.signature))}if(this.dappProvider instanceof w){let i=a=>encodeURIComponent(a).replace(/[!'()*]/g,l=>`%${l.charCodeAt(0).toString(16).toUpperCase()}`),s=t?.callbackUrl||window.location.origin;await this.dappProvider.signMessage(new b({data:R(e)}),{callbackUrl:encodeURIComponent(`${s}${s.includes("?")?"&":"?"}message=${i(e)}`)})}let o=d.get();return o.loginMethod!=="web-wallet"&&o.loginMethod!=="x-alias"&&c.run("onSignMsgFinalized",e,r),{message:e,messageSignature:r}}catch(o){let i=p(o);throw c.run("onSignMsgFailure",e,i),new Error(`Message signing failed! ${i}`)}}static async queryContract({address:e,func:t,args:r=[],value:o=0,caller:i}){if(!this.networkProvider)throw new Error("Query failed: There is no active network provider!");if(!e||!t)throw new Error("Query failed: The Query arguments are not valid! Address and func required");let s={address:e,func:t,args:r,value:o,caller:i};try{c.run("onQueryStart",s);let a=await this.networkProvider.queryContract(s);return c.run("onQueryFinalized",a),a}catch(a){let l=p(a);throw c.run("onQueryFinalized",s,l),new Error(`Smart contract query failed! ${l}`)}}static{this.storage=d}static{this.destroy=()=>{this.networkProvider=void 0,this.dappProvider=void 0,this.initOptions=void 0,c.clear()}}};var dt=({amount:n,decimals:e})=>{if(e<0)throw new Error("Decimal places shouldn't be negative number!");let t=n.toString().replace(/,/g,""),[r,o=""]=t.split("."),i=r+o.padEnd(e,"0");return i=i.substring(0,r.length+e),BigInt(i)},Ze=({amount:n,decimals:e,rounding:t=e})=>{if(e<0)throw new Error("Decimal places shouldn't be negative number!");let r=BigInt(n)<0n,o=BigInt(n).toString();r&&(o=o.slice(1)),o=o.padStart(e+1,"0");let i=o.slice(0,-e),s=o.slice(-e);if(t<e){let l=parseInt(s.charAt(t),10);if(s=s.slice(0,t),l>=5){let u=BigInt("1"+"0".repeat(e-t)),m=BigInt(n)+u;return r&&(m=-m),Ze({amount:m,decimals:e,rounding:t})}}let a=`${i}.${s.padEnd(t,"0")}`;return a=a.replace(/\.?0+$/,""),r&&(a=`-${a}`),a};export{A as Account,at as DappCoreWCV2CustomMethodsEnum,Se as ElvenJS,P as EventStoreEvents,k as LoginMethodsEnum,O as Transaction,Q as TransactionWatcher,be as WebWalletUrlParamsEnum,Ze as formatAmount,dt as parseAmount};
/** keccak.js https://github.com/adraffy/keccak.js @license MIT */
/** https://github.com/emn178/js-sha3/blob/master/src/sha3.js @license MIT */
